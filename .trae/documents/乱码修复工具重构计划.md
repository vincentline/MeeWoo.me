# 乱码修复工具重构计划

## 1. 核心修复算法设计
我们将采用 **“二进制重解释”** 与 **“启发式分块修复”** 相结合的策略，从根本上解决乱码问题。

### 模式 A：文件无损修复（精准）
针对用户上传的文件，直接操作原始二进制数据，避免浏览器默认解码造成的不可逆损坏。
- **流程**：`File` -> `ArrayBuffer` -> `TextDecoder(目标编码)` -> `修复文本`
- **优势**：100% 还原原始数据，支持 GBK、Big5、Shift-JIS、EUC-KR 等所有常见编码。

### 模式 B：文本智能修复（混合模式）
针对用户粘贴的文本（如 `/* 绌虹姸... 300px */`），解决“乱码与正常文本混合”的难题。
- **流程**：
  1. **分块**：使用正则将文本切分为 **ASCII 片段**（如 `/*`, `300px`）和 **非 ASCII 片段**（疑似乱码区）。
  2. **探测**：对每个非 ASCII 片段进行“逆向重编码测试”（如假设它是 GBK 被误读为 UTF-8）。
  3. **评分**：对比“原片段”和“修复后片段”的**中文可读性得分**（基于常用汉字频率）。
  4. **决策**：仅当修复后的可读性显著高于原文时，才应用修复。
- **效果**：能完美修复 `/* 绌虹姸... */` 中的中文，同时保护 `/*` 和 `300px` 不受影响；也能处理一段话中既有正常 UTF-8 中文又有 GBK 乱码的复杂情况。

## 2. UI/UX 设计方案
严格遵循项目现有的设计规范 (`UI-DESIGN-SYSTEM.md`) 和样式表 (`styles.css`)。

- **布局**：左右分栏结构（参考素材编辑器布局）。
  - **左侧**：输入源（支持拖拽上传文件 / 粘贴文本），配备行号显示。
  - **右侧**：实时预览修复结果，支持语法高亮（可选）。
- **组件应用**：
  - 按钮：使用 `.btn-primary`, `.btn-secondary`, `.btn-large-primary`。
  - 输入框：使用 `.input-wrapper`, `.textarea-input` 风格。
  - 弹窗/提示：复用 `.toast-container` 和 `.tooltip`。
  - 颜色：主色 `#409eff`，深色模式适配。
- **交互**：
  - **自动检测**：内容变更时自动尝试最佳修复方案。
  - **对比视图**：提供“原文/结果”快速切换对比。
  - **导出**：一键复制或下载修复后的文件。

## 3. 技术实现细节
- **文件路径**：`docs/gadgets/fix_garbled_text.html`
- **依赖**：零外部 JS 依赖，仅引用项目内的 `../assets/css/styles.css` 和 Tailwind CSS (用于布局辅助)。
- **编码支持**：利用浏览器原生 `TextDecoder` API，支持几十种国际编码。

## 4. 执行步骤
1.  **创建骨架**：编写 HTML 结构，引入 CSS。
2.  **实现算法**：编写 `GarbledFixer` 类，封装二进制处理和文本评分逻辑。
3.  **构建 UI**：实现左右分栏界面，绑定事件监听。
4.  **调试验证**：使用用户提供的乱码样本 (`/* 绌虹姸... */`) 进行测试验证。
