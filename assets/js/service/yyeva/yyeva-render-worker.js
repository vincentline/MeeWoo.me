let inverseAlphaTable=null;function initLookupTables(){if(!inverseAlphaTable){inverseAlphaTable=new Float32Array(256);for(let e=1;e<=255;e++)inverseAlphaTable[e]=255/e}}function processFrame(e){const{frameData:a,displayWidth:t,displayHeight:s,isAlphaRight:r,videoWidth:n}=e;initLookupTables();const o=Math.floor(n/2),l=r?0:o,i=r?o:0,p=new Uint8ClampedArray(t*s*4);for(let e=0;e<s;e++)for(let s=0;s<t;s++){const r=4*(e*n+(l+s)),o=4*(e*n+(i+s));if(r+3>=a.length||o+3>=a.length)continue;const c=a[r],h=a[r+1],f=a[r+2],d=a[o],u=4*(e*t+s);if(d>0)if(d<255){const e=inverseAlphaTable[d];p[u]=Math.min(255,Math.round(c*e)),p[u+1]=Math.min(255,Math.round(h*e)),p[u+2]=Math.min(255,Math.round(f*e))}else p[u]=c,p[u+1]=h,p[u+2]=f;else p[u]=0,p[u+1]=0,p[u+2]=0;p[u+3]=d}return p}self.onmessage=function(e){const{type:a,data:t,taskId:s}=e.data;try{let e;switch(a){case"processFrame":const r=performance.now();e=processFrame(t);const n=performance.now()-r;self.postMessage({type:"frameProcessed",taskId:s,result:e,time:n,dataSize:e.length},[e.buffer]);break;case"init":initLookupTables(),self.postMessage({type:"initialized",taskId:s});break;case"cleanup":inverseAlphaTable=null,self.postMessage({type:"cleanedUp",taskId:s});break;default:throw new Error(`Unknown message type: ${a}`)}}catch(e){console.error("[YYEVA Worker] Error:",e),self.postMessage({type:"error",taskId:s,error:e.message})}};