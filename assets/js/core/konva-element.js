!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var t={elementTypes:{IMAGE:"image",TEXT:"text",RECT:"rect",CIRCLE:"circle",ELLIPSE:"ellipse",LINE:"line",SVG:"svg"},createElement:function(e,t){if("undefined"==typeof Konva)throw new Error("Konva library not loaded");var n,r={id:this.generateElementId(),draggable:!0,name:"element-"+e,performance:{enableCaching:!1,cacheThreshold:500,visibleOnly:!0}},a=Object.assign({},r,t);switch(e){case this.elementTypes.IMAGE:n=this.createElementImage(a);break;case this.elementTypes.TEXT:n=this.createElementText(a);break;case this.elementTypes.RECT:n=this.createElementRect(a);break;case this.elementTypes.CIRCLE:n=this.createElementCircle(a);break;case this.elementTypes.ELLIPSE:n=this.createElementEllipse(a);break;case this.elementTypes.LINE:n=this.createElementLine(a);break;case this.elementTypes.SVG:n=this.createElementSvg(a);break;default:return console.error("Unsupported element type:",e),null}if(n&&(n.setAttr("elementType",e),n.setAttr("elementData",a),n.setAttr("performanceConfig",a.performance),a.performance.enableCaching&&n.cache))try{n.cache()}catch(e){console.warn("Error caching element:",e)}return n},createElementImage:function(e){var t=Object.assign({},{x:0,y:0,width:100,height:100,image:null,scaleX:1,scaleY:1,opacity:1},e);return new Konva.Image(t)},createElementText:function(e){var t=Object.assign({},{x:0,y:0,text:"文本内容",fontSize:24,fontFamily:"Arial",fill:"#000000",align:"center",verticalAlign:"middle"},e);return new Konva.Text(t)},createElementRect:function(e){var t=Object.assign({},{x:0,y:0,width:100,height:100,fill:"#ffffff",stroke:"#000000",strokeWidth:1,cornerRadius:0},e);return new Konva.Rect(t)},createElementCircle:function(e){var t=Object.assign({},{x:0,y:0,radius:50,fill:"#ffffff",stroke:"#000000",strokeWidth:1},e);return new Konva.Circle(t)},createElementEllipse:function(e){var t=Object.assign({},{x:0,y:0,radiusX:50,radiusY:30,fill:"#ffffff",stroke:"#000000",strokeWidth:1},e);return new Konva.Ellipse(t)},createElementLine:function(e){var t=Object.assign({},{points:[0,0,100,100],stroke:"#000000",strokeWidth:2,tension:0,lineCap:"butt",lineJoin:"miter"},e);return new Konva.Line(t)},createElementSvg:function(e){var t=Object.assign({},{x:0,y:0,width:100,height:100},e);return new Konva.Shape({x:t.x,y:t.y,width:t.width,height:t.height,drawFunc:function(e){e.fillStyle="#cccccc",e.fillRect(0,0,t.width,t.height)}})},generateElementId:function(){return"element-"+Date.now()+"-"+Math.floor(1e4*Math.random())},updateElementProperties:function(e,t,n){if(e&&e instanceof Konva.Node){var r=!1,a=e.getAttr("performanceConfig")||{},o=["width","height","scaleX","scaleY","rotation","skewX","skewY","fill","stroke","strokeWidth","opacity"];for(var i in t)if(t.hasOwnProperty(i)&&o.includes(i)){r=!0;break}e.setAttrs(t);var c=e.getAttr("elementData")||{};if(e.setAttr("elementData",Object.assign({},c,t)),r&&a.enableCaching&&e.cache&&e.clearCache)try{e.clearCache(),e.cache()}catch(e){console.warn("Error updating element cache:",e)}var s=e.getLayer();s&&(n?s.draw():e.getStage()&&e.getStage().performanceOptimizer&&e.getStage().performanceOptimizer.batchRenderer?e.getStage().performanceOptimizer.batchRenderer.addRenderTask(s):s.draw())}},getElementProperties:function(e,t){return e&&e instanceof Konva.Node?t?e.getAttr(t):e.getAttrs():null},addElementToLayer:function(e,t){e&&e instanceof Konva.Node&&t&&t instanceof Konva.Layer&&t.add(e)},removeElementFromLayer:function(e){e&&e instanceof Konva.Node&&e.remove()},destroyElement:function(e){e&&e instanceof Konva.Node&&(this.removeElementEventListeners(e),e.remove(),e.destroy())},addElementEventListener:function(e,t,n){if(e&&e instanceof Konva.Node&&"string"==typeof t&&"function"==typeof n){e.on(t,n);var r=e.getAttr("eventListeners")||{};r[t]||(r[t]=[]),r[t].push(n),e.setAttr("eventListeners",r)}},removeElementEventListeners:function(e,t){if(e&&e instanceof Konva.Node){var n=e.getAttr("eventListeners")||{};if(t)e.off(t),delete n[t];else{for(var r in n)n.hasOwnProperty(r)&&e.off(r);n={}}e.setAttr("eventListeners",n)}},setElementZIndex:function(e,t){if(e&&e instanceof Konva.Node)switch(t){case"top":e.moveToTop();break;case"bottom":e.moveToBottom();break;case"up":e.moveUp();break;case"down":e.moveDown();break;default:console.error("Unsupported z-index action:",t)}},cloneElement:function(e){if(!(e&&e instanceof Konva.Node))return null;var t=e.clone();return t.setAttr("id",this.generateElementId()),t.setAttr("eventListeners",{}),t},getElementData:function(e){return e&&e instanceof Konva.Node?{id:e.getAttr("id"),type:e.getAttr("elementType"),properties:e.getAttrs(),data:e.getAttr("elementData")||{}}:null},createElementFromData:function(e){return e&&e.type?this.createElement(e.type,e.properties||{}):null},optimizeComplexStyles:function(e,t){if(e&&e instanceof Konva.Node)if(void 0!==MeeWoo.Core.KonvaPerformance)MeeWoo.Core.KonvaPerformance.optimizeComplexStyles(e,t);else if(t){if(e.cache)try{e.cache()}catch(e){console.warn("Error caching element:",e)}}else if(e.clearCache)try{e.clearCache()}catch(e){console.warn("Error clearing cache:",e)}},isElementInViewport:function(e,t){if(!(e&&e instanceof Konva.Node&&t))return!1;if(void 0!==MeeWoo.Core.KonvaPerformance)return MeeWoo.Core.KonvaPerformance.isElementInViewport(e,t);try{var n=e.getClientRect(),r={x:0,y:0,width:t.width(),height:t.height()};return!(n.x>r.x+r.width||n.x+n.width<r.x||n.y>r.y+r.height||n.y+n.height<r.y)}catch(e){return console.warn("Error checking element visibility:",e),!0}},batchUpdateElements:function(e,n,r){if(Array.isArray(e)&&0!==e.length){var a=new Set;if(e.forEach(function(e){if(e&&e instanceof Konva.Node){t.updateElementProperties(e,n,!1);var r=e.getLayer();r&&a.add(r)}}),r)a.forEach(function(e){e.draw()});else{var o=e[0];if(o&&o.getStage()&&o.getStage().performanceOptimizer&&o.getStage().performanceOptimizer.batchRenderer){var i=o.getStage().performanceOptimizer.batchRenderer;a.forEach(function(e){i.addRenderTask(e)})}else a.forEach(function(e){e.draw()})}}}};e.MeeWoo.Core.KonvaElement=t}(window);