!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var r={initTransformer:function(e,r){if("undefined"==typeof Konva)throw new Error("Konva library not loaded");var t=Object.assign({},{borderStroke:"#0099ff",borderStrokeWidth:1,cornerStroke:"#0099ff",cornerStrokeWidth:1,cornerRadius:5,cornerFill:"#ffffff",cornerSize:10,rotatingPointOffset:40,rotatingPointRadius:8,enabledAnchors:["top-left","top-center","top-right","middle-left","middle-right","bottom-left","bottom-center","bottom-right","rotater"],padding:5,keepRatio:!1,centeredScaling:!1,centeredRotation:!0,allowEmptySelection:!1,performance:{enableThrottling:!0,throttleDelay:16,enableBatchRendering:!0}},r),n=new Konva.Transformer({name:"element-transformer",borderStroke:t.borderStroke,borderStrokeWidth:t.borderStrokeWidth,cornerStroke:t.cornerStroke,cornerStrokeWidth:t.cornerStrokeWidth,cornerRadius:t.cornerRadius,cornerFill:t.cornerFill,cornerSize:t.cornerSize,rotatingPointOffset:t.rotatingPointOffset,rotatingPointRadius:t.rotatingPointRadius,enabledAnchors:t.enabledAnchors,padding:t.padding,keepRatio:t.keepRatio,centeredScaling:t.centeredScaling,centeredRotation:t.centeredRotation,allowEmptySelection:t.allowEmptySelection});e.layers.helperLayer&&(e.layers.helperLayer.add(n),e.layers.helperLayer.draw());var a={transformer:n,stageInstance:e,config:t,isTransforming:!1,currentElement:null,startTransformState:null,transformHistory:[],performance:{lastTransformTime:0,isDragging:!1,isScaling:!1,isRotating:!1}};return this.initTransformEvents(a),a},initTransformEvents:function(e){var r=e.transformer,t=e.config,n={transformstart:this.handleTransformStart.bind(this,e),transformend:this.handleTransformEnd.bind(this,e),rotatestart:this.handleRotateStart.bind(this,e),rotateend:this.handleRotateEnd.bind(this,e),scalestart:this.handleScaleStart.bind(this,e),scaleend:this.handleScaleEnd.bind(this,e),dragstart:this.handleDragStart.bind(this,e),dragend:this.handleDragEnd.bind(this,e)},a={};if(t.performance.enableThrottling&&void 0!==MeeWoo.Core.KonvaPerformance){var o=t.performance.throttleDelay||16;a={transform:MeeWoo.Core.KonvaPerformance.throttle(this.handleTransform.bind(this,e),o),rotate:MeeWoo.Core.KonvaPerformance.throttle(this.handleRotate.bind(this,e),o),scale:MeeWoo.Core.KonvaPerformance.throttle(this.handleScale.bind(this,e),o),dragmove:MeeWoo.Core.KonvaPerformance.throttle(this.handleDragMove.bind(this,e),o)}}else a={transform:this.handleTransform.bind(this,e),rotate:this.handleRotate.bind(this,e),scale:this.handleScale.bind(this,e),dragmove:this.handleDragMove.bind(this,e)};r.on("transformstart",n.transformstart),r.on("transform",a.transform),r.on("transformend",n.transformend),r.on("rotatestart",n.rotatestart),r.on("rotate",a.rotate),r.on("rotateend",n.rotateend),r.on("scalestart",n.scalestart),r.on("scale",a.scale),r.on("scaleend",n.scaleend),r.on("dragstart",n.dragstart),r.on("dragmove",a.dragmove),r.on("dragend",n.dragend),e.eventHandlers={...n,...a}},attachTransformer:function(e,r){var t=e.transformer;Array.isArray(r)||(r=[r]),0!==(r=r.filter(function(e){return e&&e instanceof Konva.Node})).length&&(t.nodes(r),t.visible(!0),e.currentElement=r[0],t.getLayer().draw())},detachTransformer:function(e){var r=e.transformer;r.nodes([]),r.visible(!1),e.currentElement=null,r.getLayer().draw()},updateTransformerConfig:function(e,r){var t=e.transformer;Object.assign(e.config,r),t.setAttrs(r),t.getLayer().draw()},setKeepRatio:function(e,r){var t=e.transformer;t.setAttr("keepRatio",r),e.config.keepRatio=r,t.getLayer().draw()},setEnabledAnchors:function(e,r){var t=e.transformer;t.setAttr("enabledAnchors",r),e.config.enabledAnchors=r,t.getLayer().draw()},handleTransformStart:function(e,r){e.isTransforming=!0,e.startTransformState=this.saveTransformState(e.currentElement),this.triggerTransformEvent(e,"transformstart",r)},handleTransform:function(e,r){(this.triggerTransformEvent(e,"transform",r),e.config.performance.enableBatchRendering&&e.stageInstance)&&[e.stageInstance.layers.editLayer,e.stageInstance.layers.helperLayer].forEach(function(r){r&&(e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer?e.stageInstance.performanceOptimizer.batchRenderer.addRenderTask(r):r.draw())})},handleTransformEnd:function(e,r){e.isTransforming=!1,this.saveTransformHistory(e),this.triggerTransformEvent(e,"transformend",r),e.stageInstance&&e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer&&e.stageInstance.performanceOptimizer.batchRenderer.flush()},handleRotateStart:function(e,r){e.performance.isRotating=!0,this.triggerTransformEvent(e,"rotatestart",r)},handleRotate:function(e,r){(this.triggerTransformEvent(e,"rotate",r),e.config.performance.enableBatchRendering&&e.stageInstance)&&[e.stageInstance.layers.editLayer,e.stageInstance.layers.helperLayer].forEach(function(r){r&&(e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer?e.stageInstance.performanceOptimizer.batchRenderer.addRenderTask(r):r.draw())})},handleRotateEnd:function(e,r){e.performance.isRotating=!1,this.triggerTransformEvent(e,"rotateend",r),e.stageInstance&&e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer&&e.stageInstance.performanceOptimizer.batchRenderer.flush()},handleScaleStart:function(e,r){e.performance.isScaling=!0,this.triggerTransformEvent(e,"scalestart",r)},handleScale:function(e,r){(this.triggerTransformEvent(e,"scale",r),e.config.performance.enableBatchRendering&&e.stageInstance)&&[e.stageInstance.layers.editLayer,e.stageInstance.layers.helperLayer].forEach(function(r){r&&(e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer?e.stageInstance.performanceOptimizer.batchRenderer.addRenderTask(r):r.draw())})},handleScaleEnd:function(e,r){e.performance.isScaling=!1,this.triggerTransformEvent(e,"scaleend",r),e.stageInstance&&e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer&&e.stageInstance.performanceOptimizer.batchRenderer.flush()},handleDragStart:function(e,r){e.performance.isDragging=!0,this.triggerTransformEvent(e,"dragstart",r)},handleDragMove:function(e,r){(this.triggerTransformEvent(e,"dragmove",r),e.config.performance.enableBatchRendering&&e.stageInstance)&&[e.stageInstance.layers.editLayer,e.stageInstance.layers.helperLayer].forEach(function(r){r&&(e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer?e.stageInstance.performanceOptimizer.batchRenderer.addRenderTask(r):r.draw())})},handleDragEnd:function(e,r){e.performance.isDragging=!1,this.triggerTransformEvent(e,"dragend",r),e.stageInstance&&e.stageInstance.performanceOptimizer&&e.stageInstance.performanceOptimizer.batchRenderer&&e.stageInstance.performanceOptimizer.batchRenderer.flush()},triggerTransformEvent:function(e,r,t){e.stageInstance.stage.fire("transform:"+r,{transformerState:e,event:t,element:e.currentElement})},saveTransformState:function(e){return e&&e instanceof Konva.Node?{x:e.x(),y:e.y(),scaleX:e.scaleX(),scaleY:e.scaleY(),rotation:e.rotation(),skewX:e.skewX(),skewY:e.skewY(),width:e.width(),height:e.height()}:null},restoreTransformState:function(e,r){e&&e instanceof Konva.Node&&r&&(e.setAttrs({x:r.x,y:r.y,scaleX:r.scaleX,scaleY:r.scaleY,rotation:r.rotation,skewX:r.skewX,skewY:r.skewY}),e.getLayer().draw())},saveTransformHistory:function(e){if(e.currentElement){var r=this.saveTransformState(e.currentElement),t=e.startTransformState;t&&r&&(e.transformHistory.push({startState:t,endState:r,element:e.currentElement,timestamp:Date.now()}),e.transformHistory.length>100&&e.transformHistory.shift())}},getTransformer:function(e){return e.transformer},getCurrentElement:function(e){return e.currentElement},destroyTransformer:function(e){var r=e.transformer;r&&(r.off("transformstart"),r.off("transform"),r.off("transformend"),r.off("rotatestart"),r.off("rotate"),r.off("rotateend"),r.off("scalestart"),r.off("scale"),r.off("scaleend"),r.off("dragstart"),r.off("dragmove"),r.off("dragend"),r.destroy()),e.transformer=null,e.currentElement=null,e.transformHistory=[],e.eventHandlers=null,e.performance=null}};e.MeeWoo.Core.KonvaTransformer=r}(window);