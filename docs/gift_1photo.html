<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>名人礼物自助</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- 多语言字体：Google Fonts Noto Sans 系列 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Sans+Arabic:wght@400;500;700&family=Noto+Sans+Thai:wght@400;500;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        width: 100%;
        height: 100%;
        font-family: 'Noto Sans', 'Noto Sans SC', 'Noto Sans Arabic', 'Noto Sans Thai', 
                     'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        overflow: hidden;
        background-color: #fcfcfc;
        transition: background-color 0.3s;
      }

      body.dark-mode {
        background-color: #1a1a1a;
      }

      #app {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* ==================== 顶部导航栏 ==================== */
      .header-navbar {
        width: 100%;
        height: 36px;
        background-color: #ffffff;
        border-bottom: 1px solid #e3e3e3;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 16px;
        position: relative;
        z-index: 100;
        transition: background-color 0.3s, border-color 0.3s;
      }

      body.dark-mode .header-navbar {
        background-color: #2a2a2a;
        border-bottom-color: #404040;
      }

      .header-navbar-title {
        font-weight: 700;
        font-size: 12px;
        color: #2c3e50;
        transition: color 0.3s;
      }

      body.dark-mode .header-navbar-title {
        color: #e0e0e0;
      }

      .back-link {
        position: absolute;
        left: 16px;
        font-size: 12px;
        color: #409eff;
        text-decoration: none;
        cursor: pointer;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      body.dark-mode .back-link {
        color: #66b1ff;
      }

      .theme-toggle {
        position: absolute;
        right: 16px;
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .theme-toggle svg {
        width: 18px;
        height: 18px;
        fill: #2c3e50;
        transition: fill 0.3s;
      }

      body.dark-mode .theme-toggle svg {
        fill: #e0e0e0;
      }

      /* ==================== 主内容区域 ==================== */
      .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
      }

      /* 头像框列表 */
      .frame-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        max-width: 900px;
        margin: 0 auto;
      }

      .frame-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        background: #ffffff;
        border: 1px solid #e3e3e3;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .frame-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .frame-item:hover {
        background: #f5f5f5;
        border-color: #409eff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      body.dark-mode .frame-item {
        background: #2a2a2a;
        border-color: #404040;
      }

      body.dark-mode .frame-item:hover {
        background: #333333;
        border-color: #409eff;
      }

      .frame-icon {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin-bottom: 8px;
      }

      .frame-name {
        font-size: 12px;
        color: #333333;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      body.dark-mode .frame-name {
        color: #e0e0e0;
      }

      /* 加载提示 */
      .loading-tip {
        text-align: center;
        padding: 40px;
        color: #999;
        font-size: 14px;
      }

      /* ==================== 蒙层弹窗 ==================== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      body.dark-mode .modal-overlay {
        background: rgba(0, 0, 0, 0.7);
      }

      .modal-container {
        display: flex;
        width: 90%;
        max-width: 1000px;
        height: 80%;
        max-height: 700px;
        overflow: hidden;
        position: relative;
        border-radius: 16px;
        background: #ffffff;
        background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNlM2UzZTMiLz48L3N2Zz4=);
        background-size: 8px 8px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      }

      body.dark-mode .modal-container {
        background: #2a2a2a;
        background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiM0MDQwNDAiLz48L3N2Zz4=);
        background-size: 8px 8px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
      }

      /* 关闭按钮 */
      .modal-close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s;
      }

      .modal-close-btn:hover {
        background: rgba(0, 0, 0, 0.2);
        transform: scale(1.1);
      }

      .modal-close-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      body.dark-mode .modal-close-btn {
        background: rgba(255, 255, 255, 0.1);
      }

      body.dark-mode .modal-close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-close-btn svg {
        width: 16px;
        height: 16px;
        stroke: #333;
        stroke-width: 2;
      }

      body.dark-mode .modal-close-btn svg {
        stroke: #e0e0e0;
      }

      /* 左侧效果预览区 */
      .preview-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 24px;
      }

      body.dark-mode .preview-section {
        border-right-color: #404040;
      }

      .preview-player {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        max-height: 400px;
      }

      body.dark-mode .preview-player {
        background: #1a1a1a;
      }

      #svgaContainer {
        width: 400px;
        height: 400px;
      }

      .preview-info {
        margin-top: 16px;
        padding: 12px;
        background: #fff;
        border-radius: 8px;
      }

      body.dark-mode .preview-info {
        background: #1a1a1a;
      }

      /* 素材信息居中显示 */
      .material-preview-container {
        margin-top: 16px;
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .material-preview-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .material-preview-info .section-title {
        text-align: center;
      }

      .material-preview-info .material-card {
        max-width: 400px;
      }

      .info-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        font-size: 12px;
        justify-content: center;
      }

      .info-item {
        display: flex;
        gap: 4px;
      }

      .info-label {
        color: #999;
      }

      .info-value {
        color: #333;
        font-weight: 500;
      }

      .info-value.warning {
        color: #ff4444;
      }

      body.dark-mode .info-value {
        color: #e0e0e0;
      }

      body.dark-mode .info-value.warning {
        color: #ff6666;
      }

      /* 右侧设置面板 */
      .settings-panel {
        width: 360px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      }

      body.dark-mode .settings-panel {
        background: #1e1e1e;
      }

      .panel-section {
        padding: 20px;
        border-bottom: 1px solid #e3e3e3;
      }

      body.dark-mode .panel-section {
        border-bottom-color: #404040;
      }

      .panel-section:last-child {
        border-bottom: none;
      }

      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
      }

      body.dark-mode .section-title {
        color: #e0e0e0;
      }

      /* 素材卡片 */
      .material-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f5f5f5;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      body.dark-mode .material-card {
        background: #1a1a1a;
      }

      .material-thumb {
        width: 48px;
        height: 48px;
        background: #fff;
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      body.dark-mode .material-thumb {
        background: #2a2a2a;
        border-color: #404040;
      }

      .material-thumb img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .material-info {
        flex: 1;
        min-width: 0;
      }

      .material-name {
        font-size: 12px;
        color: #333;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      body.dark-mode .material-name {
        color: #e0e0e0;
      }

      .material-btns {
        display: flex;
        gap: 8px;
      }

      /* 按钮样式 */
      .btn {
        height: 28px;
        padding: 0 12px;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        background: #ffffff;
        color: #333;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .btn:hover {
        background: #f5f5f5;
        border-color: #d0d0d0;
      }

      body.dark-mode .btn {
        background: #2a2a2a;
        border-color: #404040;
        color: #e0e0e0;
      }

      body.dark-mode .btn:hover {
        background: #333333;
        border-color: #505050;
      }

      .btn-primary {
        background: #409eff;
        border-color: #409eff;
        color: #fff;
      }

      .btn-primary:hover {
        background: #66b1ff;
        border-color: #66b1ff;
      }

      .btn-success {
        background: #67c23a;
        border-color: #67c23a;
        color: #fff;
      }

      .btn-success:hover {
        background: #85ce61;
        border-color: #85ce61;
      }

      .btn-icon {
        width: 28px;
        padding: 0;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* 文本效果区域 */
      .text-effect-area {
        margin-bottom: 16px;
      }

      .text-canvas-wrapper {
        width: 100%;
        height: 70px;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        position: relative;
      }

      body.dark-mode .text-canvas-wrapper {
        background: #2a2a2a;
      }

      .text-canvas {
        max-width: 100%;
        max-height: 100%;
        border: 1px solid #e3e3e3;
      }

      .text-input {
        width: 100%;
        height: 40px;
        padding: 0 12px;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        background: #ffffff;
        color: #333;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .text-input:focus {
        outline: none;
        border-color: #409eff;
      }

      body.dark-mode .text-input {
        background: #1a1a1a;
        border-color: #404040;
        color: #e0e0e0;
      }

      /* 位置微调按钮组 */
      .position-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }

      .position-label {
        font-size: 12px;
        color: #999;
        min-width: 60px;
      }

      .position-btns {
        display: flex;
        gap: 4px;
      }

      .pos-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        border: 1px solid #e3e3e3;
        border-radius: 6px;
        background: #ffffff;
        color: #333;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .pos-btn:hover {
        background: #f5f5f5;
        border-color: #409eff;
        color: #409eff;
      }

      body.dark-mode .pos-btn {
        background: #2a2a2a;
        border-color: #404040;
        color: #e0e0e0;
      }

      body.dark-mode .pos-btn:hover {
        background: #333;
        border-color: #409eff;
        color: #409eff;
      }

      /* 底部导出按钮 */
      .export-section {
        padding: 20px;
        border-top: 1px solid #e3e3e3;
        margin-top: auto;
      }

      body.dark-mode .export-section {
        border-top-color: #404040;
      }

      .export-btn {
        width: 100%;
        height: 40px;
        font-size: 14px;
        font-weight: 500;
      }

      /* Toast 提示 */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }

      .toast.show {
        opacity: 1;
        visibility: visible;
      }

      /* 图标生成效果 */
      .icon-generator {
        display: flex;
        justify-content: center;
        padding: 16px 0;
      }

      .icon-preview {
        display: block;
        width: 300px;
        height: 300px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #f9f9f9;
      }

      body.dark-mode .icon-preview {
        border-color: #404040;
        background: #2a2a2a;
      }

      /* 裁剪弹窗 */
      .crop-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .crop-modal-content {
        background: #fff;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      body.dark-mode .crop-modal-content {
        background: #2a2a2a;
      }

      .crop-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      body.dark-mode .crop-modal-header {
        border-bottom-color: #404040;
      }

      .crop-modal-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .close-btn:hover {
        background: #f0f0f0;
      }

      body.dark-mode .close-btn {
        color: #999;
      }

      body.dark-mode .close-btn:hover {
        background: #404040;
      }

      .crop-modal-body {
        padding: 20px;
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .crop-container {
        position: relative;
        width: 100%;
        height: 500px;
        background: #f5f5f5;
        border-radius: 8px;
        overflow: hidden;
        cursor: move;
      }

      body.dark-mode .crop-container {
        background: #1a1a1a;
      }

      .crop-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .crop-controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #333;
      }

      body.dark-mode .crop-controls label {
        color: #e0e0e0;
      }

      .crop-scale-slider {
        width: 400px;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: #ddd;
        outline: none;
        border-radius: 2px;
      }

      .crop-scale-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        background: #007bff;
        cursor: pointer;
        border-radius: 50%;
      }

      .crop-scale-slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: #007bff;
        cursor: pointer;
        border-radius: 50%;
        border: none;
      }

      body.dark-mode .crop-scale-slider {
        background: #404040;
      }

      .crop-scale-value {
        min-width: 50px;
        font-weight: 500;
        color: #007bff;
      }

      body.dark-mode .crop-scale-value {
        color: #4a9eff;
      }

      .crop-canvas {
        width: 100%;
        height: 100%;
      }

      .crop-tips {
        text-align: center;
        color: #999;
        font-size: 13px;
      }

      .crop-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      body.dark-mode .crop-modal-footer {
        border-top-color: #404040;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <!-- 顶部导航栏 -->
      <div class="header-navbar">
        <a href="index.html" class="back-link">← 返回主页</a>
        <div class="header-navbar-title">名人礼物自助</div>
        <button class="theme-toggle" @click="toggleTheme" title="切换主题">
          <svg v-if="!isDarkMode" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <svg v-else viewBox="0 0 24 24">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
      </div>

      <!-- 主内容区域：头像框列表 -->
      <div class="main-content">
        <div v-if="loading" class="loading-tip">正在加载礼物列表...</div>
        <div v-else-if="frameList.length === 0" class="loading-tip">暂无礼物，请将SVGA文件放入 assets/mingren_gift_1photo 目录</div>
        <div v-else class="frame-grid">
          <div 
            v-for="(item, index) in frameList"
            :key="item.name"
            class="frame-item"
            :class="{ 'disabled': isExporting || isConvertingMP4 }"
            @click="!isExporting && !isConvertingMP4 && openFrame(item)"
          >
            <img 
              :src="'assets/mingren_gift_1photo/' + item.icon" 
              :alt="item.name" 
              class="frame-icon"
              @error="onIconError($event)"
            />
            <div class="frame-name">{{ item.name }}</div>
          </div>
        </div>
      </div>

      <!-- 蒙层弹窗 -->
      <div class="modal-overlay" :class="{show: showModal}">
        <div class="modal-container" v-if="currentFrame">
          <!-- 关闭按钮 -->
          <button class="modal-close-btn" :disabled="isExporting || isConvertingMP4" @click="closeModal" title="关闭">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <!-- 左侧效果预览区 -->
          <div class="preview-section">
            <div class="preview-player">
              <div id="svgaContainer"></div>
            </div>
            <div class="preview-info">
              <div class="info-row">
                <div class="info-item">
                  <span class="info-label">文件名：</span>
                  <span class="info-value">{{ currentFrame.name }}.svga</span>
                </div>
                <div class="info-item">
                  <span class="info-label">文件大小：</span>
                  <span class="info-value">{{ svgaInfo.sizeText }}</span>
                </div>
              </div>
              <div class="info-row" style="margin-top: 8px;">
                <div class="info-item">
                  <span class="info-label">尺寸：</span>
                  <span class="info-value">{{ svgaInfo.width }}×{{ svgaInfo.height }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">帧率：</span>
                  <span class="info-value">{{ svgaInfo.fps }} FPS</span>
                </div>
                <div class="info-item">
                  <span class="info-label">内存占用：</span>
                  <span class="info-value" :class="{warning: isMemoryHigh}">{{ svgaInfo.memoryText }}</span>
                </div>
              </div>
            </div>
            
            <!-- 素材信息居中显示 -->
            <div class="material-preview-container" v-if="materials.zaky">
              <div class="material-preview-info">
                <div class="section-title">素材：zaky</div>
                <div class="material-card">
                  <div class="material-thumb">
                    <img :src="materials.zaky.previewUrl" v-if="materials.zaky.previewUrl" />
                  </div>
                  <div class="material-info">
                    <div class="material-name">{{ materials.zaky.sizeText }}</div>
                  </div>
                  <div class="material-btns">
                    <button class="btn" :disabled="isExporting || isConvertingMP4" @click="replaceMaterial('zaky')">替换</button>
                    <button class="btn btn-icon" :disabled="isExporting || isConvertingMP4" @click="downloadMaterial('zaky')" title="下载">↓</button>
                    <button class="btn btn-icon" :disabled="isExporting || isConvertingMP4" v-if="replacedImages.zaky" @click="restoreMaterial('zaky')" title="恢复">↺</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 右侧设置面板 -->
          <div class="settings-panel">
            <!-- 图标生成效果 -->
            <div class="panel-section" v-if="materials.zaky">
              <div class="section-title">图标生成效果</div>
              <div class="icon-generator">
                <canvas ref="iconCanvas" width="300" height="300" class="icon-preview"></canvas>
              </div>
            </div>

            <!-- 无素材提示 -->
            <div class="panel-section" v-if="!materials.zaky">
              <div class="loading-tip">未检测到 zaky 素材</div>
            </div>

            <!-- 导出按钮 -->
            <div class="export-section">
              <button 
                class="btn btn-success export-btn" 
                :disabled="!canExportMP4 || isConvertingMP4 || isExporting"
                @click="exportMP4AndIcon"
              >
                <span v-if="!isConvertingMP4">导出双通道MP4和PNG图标</span>
                <span v-else>{{ mp4ConvertStage }} {{ mp4ConvertProgress }}%</span>
              </button>
              <button 
                class="btn btn-success export-btn" 
                style="margin-top: 8px;"
                :disabled="!canExport || isExporting"
                @click="exportAll"
              >
                导出新SVGA和PNG图标
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast 提示 -->
      <div class="toast" :class="{show: toastVisible}">{{ toastMessage }}</div>

      <!-- 裁剪图片弹窗 -->
      <div class="crop-modal" v-if="showCropModal" @click.self="!isExporting && !isConvertingMP4 && closeCropModal">
        <div class="crop-modal-content">
          <div class="crop-modal-header">
            <h3>裁剪图片（322×423）</h3>
            <button class="close-btn" :disabled="isExporting || isConvertingMP4" @click="closeCropModal">×</button>
          </div>
          <div class="crop-modal-body">
            <div class="crop-container">
              <canvas ref="cropCanvas" class="crop-canvas"></canvas>
            </div>
            <div class="crop-controls">
              <label>
                缩放：
                <input 
                  type="range" 
                  min="0.1" 
                  max="4" 
                  step="0.0025" 
                  v-model.number="cropImageScale" 
                  @input="renderCropCanvas"
                  class="crop-scale-slider"
                />
                <span class="crop-scale-value">{{ Math.round(cropImageScale * 100) }}%</span>
              </label>
            </div>
            <div class="crop-tips">
              拖动调整图片位置，滚轮或滑块缩放图片
            </div>
          </div>
          <div class="crop-modal-footer">
            <button class="btn" :disabled="isExporting || isConvertingMP4" @click="closeCropModal">取消</button>
            <button class="btn btn-primary" :disabled="isExporting || isConvertingMP4" @click="confirmCrop">确认裁剪</button>
          </div>
        </div>
      </div>

      <!-- 隐藏的文件输入框 -->
      <input type="file" ref="fileInput" accept="image/*" style="display:none" @change="handleFileSelect" />
    </div>

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <!-- SVGA播放器 -->
    <script src="https://cdn.jsdelivr.net/npm/svgaplayerweb@2.3.1/build/svga.min.js"></script>
    <!-- Protobuf.js -->
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
    <!-- Pako -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.0.4/dist/pako.min.js"></script>

    <script>
      new Vue({
        el: '#app',
        data: function () {
          return {
            // 主题
            isDarkMode: false,
            
            // 加载状态
            loading: true,
            
            // 礼物列表
            frameList: [],
            
            // 弹窗状态
            showModal: false,
            currentFrame: null,
            
            // SVGA相关
            svgaPlayer: null,
            svgaParser: null,
            svgaVideoItem: null,
            svgaFile: null,
            svgaInfo: {
              width: 0,
              height: 0,
              fps: 0,
              sizeText: '',
              memoryText: ''
            },
            
            // 素材
            materials: {
              zaky: null
            },
            
            // 替换的图片 {imageKey: base64}
            replacedImages: {},
            
            // 裁剪相关
            showCropModal: false,
            cropImage: null,  // 当前裁剪的图片
            cropImageScale: 1,
            cropImageOffset: { x: 0, y: 0 },
            cropDragging: false,
            cropDragStart: { x: 0, y: 0 },
            croppedImageData: null,  // 裁剪后的图片数据
            
            // MP4转换状态
            isConvertingMP4: false,
            mp4ConvertProgress: 0,
            mp4ConvertStage: '',
            
            // 导出状态
            isExporting: false,
            
            // 当前替换目标
            currentReplaceTarget: null,
            
            // Toast
            toastVisible: false,
            toastMessage: ''
          };
        },
        computed: {
          canExport: function() {
            return Object.keys(this.replacedImages).length > 0;
          },
          canExportMP4: function() {
            return this.svgaVideoItem !== null;
          },
          isMemoryHigh: function() {
            // 判断内存是否超过8M
            var memText = this.svgaInfo.memoryText;
            if (!memText || memText === '-' || memText === '计算中...') {
              return false;
            }
            // 提取数字，如 "12.34M"
            var match = memText.match(/([\d.]+)\s*M/);
            if (match) {
              var mb = parseFloat(match[1]);
              return mb > 8;
            }
            return false;
          }
        },
        mounted: function() {
          var _this = this;
          // 初始化主题
          var savedTheme = localStorage.getItem('dar_theme');
          if (savedTheme === 'dark') {
            this.isDarkMode = true;
            document.body.classList.add('dark-mode');
          }
          // 加载头像框列表
          this.loadFrameList();
          
          // 监听全局鼠标事件用于裁剪拖拽
          document.addEventListener('mousemove', this.onCropDragMove);
          document.addEventListener('mouseup', this.onCropDragEnd);
        },
        beforeDestroy: function() {
          document.removeEventListener('mousemove', this.onCropDragMove);
          document.removeEventListener('mouseup', this.onCropDragEnd);
        },
        methods: {
          // 切换主题
          toggleTheme: function() {
            this.isDarkMode = !this.isDarkMode;
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('dar_theme', this.isDarkMode ? 'dark' : 'light');
          },
          
          // 加载礼物列表
          loadFrameList: function() {
            var _this = this;
            // 从file-list.json加载
            fetch('assets/mingren_gift_1photo/file-list.json')
              .then(function(res) { return res.json(); })
              .then(function(list) {
                _this.frameList = list.map(function(item) {
                  return {
                    name: item.name,
                    svga: item.svga,  // 远程URL
                    icon: item.name + '.png'  // 本地PNG图标
                  };
                });
                _this.loading = false;
              })
              .catch(function() {
                // 如果没有file-list.json，显示空列表
                _this.frameList = [];
                _this.loading = false;
              });
          },
          
          // 图标加载失败时使用默认图标
          onIconError: function(e) {
            e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiNmMGYwZjAiLz48dGV4dCB4PSI0MCIgeT0iNDUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlNWR0E8L3RleHQ+PC9zdmc+';
          },
          
          // 打开头像框
          openFrame: function(item) {
            var _this = this;
            
            // 清理之前的播放器
            if (_this.svgaPlayer) {
              _this.svgaPlayer.clear();
            }
            
            _this.currentFrame = item;
            _this.showModal = true;
            _this.materials = { name01: null, Username01: null };
            _this.replacedImages = {};
            _this.textInput1 = '';
            _this.textInput2 = '';
            _this.textOffset1 = { x: 0, y: 0 };
            _this.textOffset2 = { x: 0, y: 0 };
            
            // 加载SVGA
            _this.$nextTick(function() {
              _this.loadSVGA(item);
            });
          },
          
          // 关闭弹窗
          closeModal: function() {
            this.showModal = false;
            if (this.svgaPlayer) {
              this.svgaPlayer.clear();
            }
            this.currentFrame = null;
          },
          
          // 加载SVGA文件
          loadSVGA: function(item) {
            var _this = this;
            // 添加时间戳防止缓存（仅对远程URL）
            var svgaUrl = item.svga;
            if (svgaUrl.indexOf('http') === 0) {
              svgaUrl += (svgaUrl.indexOf('?') > -1 ? '&' : '?') + '_t=' + Date.now();
            }
            
            // 每次都重新初始化播放器（确保干净状态）
            var container = document.getElementById('svgaContainer');
            if (container) {
              container.innerHTML = ''; // 清空容器
            }
            _this.svgaPlayer = new SVGA.Player('#svgaContainer');
            _this.svgaParser = new SVGA.Parser('#svgaContainer');
            
            // 先获取文件大小和Blob（添加mode: 'cors'）
            fetch(svgaUrl, { mode: 'cors' })
              .then(function(res) {
                if (!res.ok) {
                  throw new Error('HTTP ' + res.status + ': ' + res.statusText);
                }
                var size = res.headers.get('content-length');
                _this.svgaInfo.sizeText = _this.formatBytes(parseInt(size) || 0);
                return res.blob();
              })
              .then(function(blob) {
                // 保存文件数据用于导出
                _this.svgaFile = blob;
                
                // 使用 URL.createObjectURL 创建临时URL
                var objectUrl = URL.createObjectURL(blob);
                
                // 用临时URL加载SVGA（避免 incorrect header check 错误）
                _this.svgaParser.load(objectUrl, function(videoItem) {
                  // 释放临时URL
                  URL.revokeObjectURL(objectUrl);
                  
                  _this.svgaVideoItem = videoItem;
                  _this.svgaPlayer.setVideoItem(videoItem);
                  _this.svgaPlayer.loops = 0; // 循环播放
                  _this.svgaPlayer.startAnimation();
                  
                  // 更新信息
                  _this.svgaInfo.width = videoItem.videoSize.width;
                  _this.svgaInfo.height = videoItem.videoSize.height;
                  _this.svgaInfo.fps = videoItem.FPS;
                  
                  // 计算内存占用（使用index.html的算法）
                  var images = videoItem.images || {};
                  var imageKeys = Object.keys(images);
                  var totalBytes = 0;
                  var processedCount = 0;
                  var imageCount = imageKeys.length;
                  
                  if (imageCount > 0) {
                    imageKeys.forEach(function(imgKey) {
                      var imgData = images[imgKey];
                      if (imgData && typeof imgData === 'string') {
                        var img = new Image();
                        img.onload = function() {
                          totalBytes += this.width * this.height * 4;
                          processedCount++;
                          if (processedCount === imageCount) {
                            var mb = totalBytes / 1048576;
                            _this.svgaInfo.memoryText = mb.toFixed(2) + 'M';
                          }
                        };
                        img.onerror = function() {
                          processedCount++;
                          if (processedCount === imageCount) {
                            var mb = totalBytes / 1048576;
                            _this.svgaInfo.memoryText = mb.toFixed(2) + 'M';
                          }
                        };
                        img.src = imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData);
                      } else {
                        processedCount++;
                      }
                    });
                    
                    if (processedCount === imageCount && totalBytes > 0) {
                      var mb = totalBytes / 1048576;
                      _this.svgaInfo.memoryText = mb.toFixed(2) + 'M';
                    } else {
                      _this.svgaInfo.memoryText = '计算中...';
                    }
                  } else {
                    _this.svgaInfo.memoryText = '-';
                  }
                  
                  // 提取name01和Username01素材
                  _this.extractMaterials(videoItem);
                }, function(err) {
                  URL.revokeObjectURL(objectUrl);
                  console.error('SVGA解析错误:', err);
                  var errMsg = err && err.message ? err.message : String(err);
                  if (errMsg.indexOf('header check') > -1) {
                    _this.showToast('加载SVGA失败: 文件格式错误，请检查跨域CORS配置');
                  } else {
                    _this.showToast('加载SVGA失败: ' + errMsg);
                  }
                });
              })
              .catch(function(err) {
                console.error('获取文件错误:', err);
                var errMsg = err && err.message ? err.message : String(err);
                _this.showToast('获取文件失败: ' + errMsg + ' (请检查网络和CORS设置)');
              });
          },
          
          // 提取素材
          extractMaterials: function(videoItem) {
            var _this = this;
            var images = videoItem.images || {};
            
            ['zaky'].forEach(function(key) {
              if (images[key]) {
                var imgData = images[key];
                var previewUrl = '';
                
                if (typeof imgData === 'string') {
                  previewUrl = imgData.startsWith('data:') ? imgData : ('data:image/png;base64,' + imgData);
                }
                
                // 获取尺寸
                var img = new Image();
                img.onload = function() {
                  _this.materials[key] = {
                    previewUrl: previewUrl,
                    width: this.width,
                    height: this.height,
                    sizeText: this.width + '×' + this.height
                  };
                  _this.$forceUpdate();
                  
                  // 初始化Canvas尺寸
                  _this.$nextTick(function() {
                    if (key === 'name01' && _this.$refs.textCanvas1) {
                      _this.$refs.textCanvas1.width = _this.materials.name01.width;
                      _this.$refs.textCanvas1.height = _this.materials.name01.height;
                      _this.renderText1();
                    }
                    if (key === 'Username01' && _this.$refs.textCanvas2) {
                      _this.$refs.textCanvas2.width = _this.materials.Username01.width;
                      _this.$refs.textCanvas2.height = _this.materials.Username01.height;
                      _this.renderText2();
                    }
                  });
                };
                img.src = previewUrl;
              }
            });
          },
          
          // 应用替换到SVGA播放器
          applyToSVGA: function(imageKey, dataUrl) {
            var _this = this;
            var img = new Image();
            img.onload = function() {
              _this.svgaPlayer.setImage(img, imageKey);
              _this.svgaPlayer.startAnimation();
            };
            img.src = dataUrl;
          },
          
          // 替换素材（打开裁剪弹窗）
          replaceMaterial: function(key) {
            this.currentReplaceTarget = key;
            this.$refs.fileInput.click();
          },
          
          // 处理文件选择（打开裁剪弹窗）
          handleFileSelect: function(e) {
            var _this = this;
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(evt) {
              var img = new Image();
              img.onload = function() {
                _this.cropImage = img;
                _this.showCropModal = true;
                _this.cropImageScale = 1;
                _this.cropImageOffset = { x: 0, y: 0 };
                _this.$nextTick(function() {
                  _this.initCropCanvas();
                });
              };
              img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';  // 清空，允许选择同一文件
          },
          
          // 缩放图片到指定尺寸
          scaleImageToSize: function(dataUrl, width, height, callback) {
            var img = new Image();
            img.onload = function() {
              var canvas = document.createElement('canvas');
              canvas.width = width;
              canvas.height = height;
              var ctx = canvas.getContext('2d');
              
              // 计算缩放比例（保持比例，居中填充）
              var scale = Math.max(width / img.width, height / img.height);
              var scaledWidth = img.width * scale;
              var scaledHeight = img.height * scale;
              var x = (width - scaledWidth) / 2;
              var y = (height - scaledHeight) / 2;
              
              ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
              callback(canvas.toDataURL('image/png'));
            };
            img.src = dataUrl;
          },
          
          // ========== 裁剪功能 ==========
          
          // 初始化裁剪画布
          initCropCanvas: function() {
            var _this = this;
            var canvas = this.$refs.cropCanvas;
            if (!canvas) return;
            
            // 设置画布尺寸
            var container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            this.renderCropCanvas();
            
            // 添加事件监听
            canvas.addEventListener('mousedown', this.startCropDrag);
            canvas.addEventListener('wheel', this.handleCropWheel);
          },
          
          // 渲染裁剪画布
          renderCropCanvas: function() {
            var canvas = this.$refs.cropCanvas;
            if (!canvas || !this.cropImage) return;
            
            var ctx = canvas.getContext('2d');
            var cw = canvas.width;
            var ch = canvas.height;
            
            // 清空
            ctx.clearRect(0, 0, cw, ch);
            
            // 绘制图片
            var img = this.cropImage;
            var scale = this.cropImageScale;
            var offset = this.cropImageOffset;
            
            var imgW = img.width * scale;
            var imgH = img.height * scale;
            var imgX = (cw - imgW) / 2 + offset.x;
            var imgY = (ch - imgH) / 2 + offset.y;
            
            ctx.drawImage(img, imgX, imgY, imgW, imgH);
            
            // 绘制裁剪框 322x423
            var cropW = 322;
            var cropH = 423;
            var cropX = (cw - cropW) / 2;
            var cropY = (ch - cropH) / 2;
            
            // 遮罩层
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, cw, cropY);
            ctx.fillRect(0, cropY, cropX, cropH);
            ctx.fillRect(cropX + cropW, cropY, cw - cropX - cropW, cropH);
            ctx.fillRect(0, cropY + cropH, cw, ch - cropY - cropH);
            
            // 裁剪框边框
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(cropX, cropY, cropW, cropH);
            
            // 裁剪框尺寸文字
            ctx.fillStyle = '#fff';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('322 × 423', cw / 2, cropY - 10);
          },
          
          // 开始拖拽
          startCropDrag: function(e) {
            this.cropDragging = true;
            this.cropDragStart = { x: e.clientX, y: e.clientY };
          },
          
          // 拖拽移动
          onCropDragMove: function(e) {
            if (!this.cropDragging) return;
            
            var dx = e.clientX - this.cropDragStart.x;
            var dy = e.clientY - this.cropDragStart.y;
            
            this.cropImageOffset.x += dx;
            this.cropImageOffset.y += dy;
            this.cropDragStart = { x: e.clientX, y: e.clientY };
            
            this.renderCropCanvas();
          },
          
          // 结束拖拽
          onCropDragEnd: function() {
            this.cropDragging = false;
          },
          
          // 滚轮缩放
          handleCropWheel: function(e) {
            e.preventDefault();
            var delta = e.deltaY > 0 ? -0.05 : 0.05;  // 缩放倍率改小
            this.cropImageScale = Math.max(0.1, Math.min(5, this.cropImageScale + delta));
            this.renderCropCanvas();
          },
          
          // 关闭裁剪弹窗
          closeCropModal: function() {
            this.showCropModal = false;
            this.cropImage = null;
            this.cropImageScale = 1;
            this.cropImageOffset = { x: 0, y: 0 };
          },
          
          // 确认裁剪
          confirmCrop: function() {
            var _this = this;
            var canvas = this.$refs.cropCanvas;
            if (!canvas || !this.cropImage) return;
            
            // 创建临时画布裁剪
            var cropCanvas = document.createElement('canvas');
            cropCanvas.width = 322;
            cropCanvas.height = 423;
            var cropCtx = cropCanvas.getContext('2d');
            
            var cw = canvas.width;
            var ch = canvas.height;
            var cropX = (cw - 322) / 2;
            var cropY = (ch - 423) / 2;
            
            // 复制裁剪区域
            var img = this.cropImage;
            var scale = this.cropImageScale;
            var offset = this.cropImageOffset;
            
            var imgW = img.width * scale;
            var imgH = img.height * scale;
            var imgX = (cw - imgW) / 2 + offset.x;
            var imgY = (ch - imgH) / 2 + offset.y;
            
            // 计算裁剪区域在原图片上的位置
            var sx = (cropX - imgX) / scale;
            var sy = (cropY - imgY) / scale;
            var sw = 322 / scale;
            var sh = 423 / scale;
            
            cropCtx.drawImage(img, sx, sy, sw, sh, 0, 0, 322, 423);
            
            var croppedDataUrl = cropCanvas.toDataURL('image/png');
            this.croppedImageData = croppedDataUrl;
            
            // 应用到SVGA
            var key = this.currentReplaceTarget;
            this.$set(this.replacedImages, key, croppedDataUrl);
            this.applyToSVGA(key, croppedDataUrl);
            
            // 生成图标
            this.generateIcon();
            
            this.closeCropModal();
            this.showToast('已裁剪并应用到 ' + key);
          },
          
          // ========== 图标生成 ==========
          
          // 生成图标
          generateIcon: function() {
            var _this = this;
            var canvas = this.$refs.iconCanvas;
            if (!canvas) return;
            
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 300, 300);
            
            // 等待所有图片加载完成
            var loadCount = 0;
            var colorImg = null;
            var zakyImg = null;
            var maskImg = null;
            
            function checkComplete() {
              loadCount++;
              if (loadCount === 3) {
                drawIcon();
              }
            }
            
            function drawIcon() {
              // 1. 先在临时画布上绘制 zaky 并应用遮罩
              var maskedZakyCanvas = null;
              if (zakyImg) {
                var zakyW = 155.57;
                var zakyH = 204.36;
                
                // 创建 300x300 的临时画布（和遮罩一样大）
                var tempCanvas = document.createElement('canvas');
                tempCanvas.width = 300;
                tempCanvas.height = 300;
                var tempCtx = tempCanvas.getContext('2d');
                
                // 在临时画布上绘制旋转的 zaky
                var zakyX = 76.82;
                var zakyY = 42.71;
                tempCtx.save();
                tempCtx.translate(zakyX + zakyW/2, zakyY + zakyH/2);
                tempCtx.rotate(15 * Math.PI / 180);
                tempCtx.drawImage(zakyImg, -zakyW/2, -zakyH/2, zakyW, zakyH);
                tempCtx.restore();
                
                // 应用遮罩（在临时画布上）
                if (maskImg) {
                  tempCtx.globalCompositeOperation = 'destination-in';
                  tempCtx.drawImage(maskImg, 0, 0, 300, 300);
                }
                
                maskedZakyCanvas = tempCanvas;
              }
              
              // 2. 绘制到主画布
              if (maskedZakyCanvas) {
                ctx.drawImage(maskedZakyCanvas, 0, 0, 300, 300);
              }
              
              // 3. 上层：color 图标 (300x300) - 最后绘制，盖住 zaky
              if (colorImg) {
                ctx.drawImage(colorImg, 0, 0, 300, 300);
              }
            }
            
            // 加载 zaky 裁剪图
            if (this.croppedImageData) {
              var zakyImage = new Image();
              zakyImage.onload = function() {
                zakyImg = zakyImage;
                checkComplete();
              };
              zakyImage.onerror = checkComplete;
              zakyImage.src = this.croppedImageData;
            } else {
              checkComplete();
            }
            
            // 加载 musk 遮罩
            var maskImage = new Image();
            maskImage.onload = function() {
              maskImg = maskImage;
              checkComplete();
            };
            maskImage.onerror = checkComplete;
            maskImage.src = 'assets/img/icon_musk.png';
            
            // 加载 color 图标
            if (this.currentFrame && this.currentFrame.icon) {
              var colorImage = new Image();
              colorImage.onload = function() {
                colorImg = colorImage;
                checkComplete();
              };
              colorImage.onerror = checkComplete;
              colorImage.src = 'assets/mingren_gift_1photo/' + this.currentFrame.icon;
            } else {
              checkComplete();
            }
          },
          
          // 生成带时间戳的文件名
          getTimestampFilename: function(baseName, ext) {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var hour = String(now.getHours()).padStart(2, '0');
            var minute = String(now.getMinutes()).padStart(2, '0');
            var second = String(now.getSeconds()).padStart(2, '0');
            var timestamp = '' + year + month + day + hour + minute + second;
            return timestamp + '_' + baseName + '.' + ext;
          },
          
          // 导出 SVGA 和 PNG 图标
          exportAll: function() {
            this.isExporting = true;
            
            try {
              // 导出 SVGA
              this.exportSVGA();
              
              // 延迟50ms后导出PNG，避免同时下载问题
              var _this = this;
              setTimeout(function() {
                _this.exportIconPNG();
                _this.isExporting = false;
              }, 50);
            } catch (err) {
              console.error('导出错误:', err);
              this.isExporting = false;
            }
          },
          
          // 导出 PNG 图标
          exportIconPNG: function() {
            var canvas = this.$refs.iconCanvas;
            if (canvas) {
              var baseName = this.currentFrame ? this.currentFrame.name : 'icon';
              var filename = this.getTimestampFilename(baseName + '_icon', 'png');
              
              var dataUrl = canvas.toDataURL('image/png');
              var a = document.createElement('a');
              a.href = dataUrl;
              a.download = filename;
              a.click();
            }
          },
          
          // 导出 MP4 和 PNG 图标
          exportMP4AndIcon: async function() {
            var _this = this;
            
            if (!this.svgaVideoItem) {
              this.showToast('请先选择一个礼物');
              return;
            }
            
            this.isExporting = true;
            
            try {
              // 先导出PNG图标
              this.exportIconPNG();
              
              // 延迟50ms后导出MP4
              await new Promise(function(r) { setTimeout(r, 50); });
              await this.convertToMP4();
            } catch (err) {
              console.error('MP4导出错误:', err);
              this.showToast('MP4导出失败: ' + err.message);
            } finally {
              this.isExporting = false;
            }
          },
          
          // 转换为MP4（双通道）
          convertToMP4: async function() {
            var _this = this;
            
            _this.isConvertingMP4 = true;
            _this.mp4ConvertProgress = 0;
            
            try {
              // 获取SVGA信息
              var width = _this.svgaInfo.width || 0;
              var height = _this.svgaInfo.height || 0;
              var fps = _this.svgaInfo.fps || 30;
              
              if (width === 0 || height === 0) {
                _this.showToast('SVGA尺寸信息错误');
                _this.isConvertingMP4 = false;
                return;
              }
              
              // 1. 加载FFmpeg
              _this.mp4ConvertStage = '加载转换器';
              _this.mp4ConvertProgress = 5;
              await _this.loadFFmpegForGift();
              
              // 2. 提取序列帧
              _this.mp4ConvertStage = '提取序列帧';
              _this.mp4ConvertProgress = 15;
              var frames = await _this.extractFramesForMP4(width, height);
              
              // 3. 合成双通道
              _this.mp4ConvertStage = '合成双通道';
              _this.mp4ConvertProgress = 45;
              var dualFrames = await _this.composeDualChannelFrames(frames, width, height);
              
              // 4. 编码MP4
              _this.mp4ConvertStage = '编码MP4';
              _this.mp4ConvertProgress = 70;
              var mp4Blob = await _this.encodeToMP4(dualFrames, width, height, fps, 70);
              
              // 5. 下载
              _this.mp4ConvertProgress = 95;
              var baseName = _this.currentFrame ? _this.currentFrame.name : 'gift';
              var filename = _this.getTimestampFilename(baseName + '_dual', 'mp4');
              
              var url = URL.createObjectURL(mp4Blob);
              var a = document.createElement('a');
              a.href = url;
              a.download = filename;
              a.click();
              URL.revokeObjectURL(url);
              
              _this.mp4ConvertProgress = 100;
              _this.showToast('MP4导出成功');
              
            } catch (err) {
              console.error('MP4转换错误:', err);
              _this.showToast('MP4转换失败: ' + err.message);
            } finally {
              _this.isConvertingMP4 = false;
              _this.mp4ConvertStage = '';
              _this.mp4ConvertProgress = 0;
            }
          },
          
          // 加载FFmpeg
          loadFFmpegForGift: async function() {
            if (window.ffmpegInstance && window.ffmpegLoaded) {
              return window.ffmpegInstance;
            }
            
            // 加载FFmpeg脚本
            if (!window.FFmpeg) {
              await new Promise(function(resolve, reject) {
                var script = document.createElement('script');
                script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
              });
            }
            
            var ffmpeg = window.FFmpeg.createFFmpeg({ log: false });
            await ffmpeg.load();
            
            window.ffmpegInstance = ffmpeg;
            window.ffmpegLoaded = true;
            
            return ffmpeg;
          },
          
          // 提取序列帧
          extractFramesForMP4: async function(targetWidth, targetHeight) {
            var _this = this;
            var frames = [];
            var totalFrames = _this.svgaVideoItem.frames;
            var player = _this.svgaPlayer;
            
            // 保存原始播放状态
            var wasPlaying = !player.paused;
            if (wasPlaying) {
              player.pauseAnimation();
            }
            
            // 获取SVGA播放器的canvas元素
            var container = document.getElementById('svgaContainer');
            var canvas = container.querySelector('canvas');
            
            if (!canvas) {
              throw new Error('未找到SVGA canvas元素');
            }
            
            for (var i = 0; i < totalFrames; i++) {
              player.stepToFrame(i);
              
              // 等待渲染完成
              await new Promise(function(r) { setTimeout(r, 16); }); // ~1帧的时间
              
              var tempCanvas = document.createElement('canvas');
              tempCanvas.width = targetWidth;
              tempCanvas.height = targetHeight;
              var ctx = tempCanvas.getContext('2d');
              ctx.imageSmoothingEnabled = false;
              ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
              
              var imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
              frames.push(imageData);
              
              if (i % 5 === 0) {
                await new Promise(function(r) { setTimeout(r, 0); });
              }
            }
            
            // 恢复播放状态
            if (wasPlaying) {
              player.startAnimation();
            } else {
              player.stepToFrame(0);
            }
            
            return frames;
          },
          
          // 合成双通道帧
          composeDualChannelFrames: async function(frames, width, height) {
            var dualFrames = [];
            
            for (var i = 0; i < frames.length; i++) {
              var dualCanvas = this.composeDualChannel(frames[i], true);
              dualFrames.push(dualCanvas);
              
              if (i % 5 === 0) {
                await new Promise(function(r) { setTimeout(r, 0); });
              }
            }
            
            return dualFrames;
          },
          
          // 单帧双通道合成
          composeDualChannel: function(imageData, isColorLeftAlphaRight) {
            var width = imageData.width;
            var height = imageData.height;
            
            var dualCanvas = document.createElement('canvas');
            dualCanvas.width = width * 2;
            dualCanvas.height = height;
            var dualCtx = dualCanvas.getContext('2d', { alpha: true, willReadFrequently: true });
            dualCtx.imageSmoothingEnabled = false;
            dualCtx.clearRect(0, 0, width * 2, height);
            
            var leftData = dualCtx.createImageData(width, height);
            var rightData = dualCtx.createImageData(width, height);
            
            for (var i = 0; i < imageData.data.length; i += 4) {
              var r = imageData.data[i + 0];
              var g = imageData.data[i + 1];
              var b = imageData.data[i + 2];
              var a = imageData.data[i + 3];
              
              var finalR = r, finalG = g, finalB = b;
              if (a > 0 && a < 255) {
                finalR = Math.min(255, Math.round(r * 255 / a));
                finalG = Math.min(255, Math.round(g * 255 / a));
                finalB = Math.min(255, Math.round(b * 255 / a));
              } else if (a === 0) {
                finalR = finalG = finalB = 0;
              }
              
              if (isColorLeftAlphaRight) {
                leftData.data[i + 0] = finalR;
                leftData.data[i + 1] = finalG;
                leftData.data[i + 2] = finalB;
                leftData.data[i + 3] = a;
                
                rightData.data[i + 0] = a;
                rightData.data[i + 1] = a;
                rightData.data[i + 2] = a;
                rightData.data[i + 3] = 255;
              }
            }
            
            dualCtx.putImageData(leftData, 0, 0);
            dualCtx.putImageData(rightData, width, 0);
            
            return dualCanvas;
          },
          
          // 编码为MP4
          encodeToMP4: async function(dualFrames, width, height, fps, quality) {
            var _this = this;
            var ffmpeg = window.ffmpegInstance;
            
            // 写入帧数据
            for (var i = 0; i < dualFrames.length; i++) {
              var canvas = dualFrames[i];
              
              // 加黑底
              var blackCanvas = document.createElement('canvas');
              blackCanvas.width = width * 2;
              blackCanvas.height = height;
              var blackCtx = blackCanvas.getContext('2d');
              var dualData = canvas.getContext('2d').getImageData(0, 0, width * 2, height);
              var blackData = blackCtx.createImageData(width * 2, height);
              
              for (var j = 0; j < dualData.data.length; j += 4) {
                blackData.data[j + 0] = dualData.data[j + 0];
                blackData.data[j + 1] = dualData.data[j + 1];
                blackData.data[j + 2] = dualData.data[j + 2];
                blackData.data[j + 3] = 255;
              }
              blackCtx.putImageData(blackData, 0, 0);
              
              // 转为JPEG
              var blob = await new Promise(function(resolve) {
                blackCanvas.toBlob(resolve, 'image/jpeg', 0.6);
              });
              
              var data = new Uint8Array(await blob.arrayBuffer());
              var filename = 'frame_' + String(i).padStart(4, '0') + '.jpg';
              ffmpeg.FS('writeFile', filename, data);
              
              if (i % 5 === 0) {
                await new Promise(function(r) { setTimeout(r, 0); });
              }
            }
            
            // FFmpeg命令
            var crf = Math.round(18 + (100 - quality) * 0.33);
            var args = [
              '-framerate', String(fps),
              '-i', 'frame_%04d.jpg',
              '-c:v', 'libx264',
              '-profile:v', 'high',
              '-level', '4.0',
              '-pix_fmt', 'yuv420p',
              '-crf', String(crf),
              '-preset', 'medium',
              '-movflags', '+faststart',
              '-an',
              'output.mp4'
            ];
            
            await ffmpeg.run.apply(ffmpeg, args);
            
            // 读取输出
            var mp4Data = ffmpeg.FS('readFile', 'output.mp4');
            var mp4Blob = new Blob([mp4Data.buffer], { type: 'video/mp4' });
            
            // 清理
            for (var k = 0; k < dualFrames.length; k++) {
              try {
                ffmpeg.FS('unlink', 'frame_' + String(k).padStart(4, '0') + '.jpg');
              } catch (e) {}
            }
            try {
              ffmpeg.FS('unlink', 'output.mp4');
            } catch (e) {}
            
            return mp4Blob;
          },
          
          // 下载素材
          downloadMaterial: function(key) {
            var material = this.materials[key];
            if (!material || !material.previewUrl) return;
            
            var a = document.createElement('a');
            a.href = material.previewUrl;
            a.download = key + '.png';
            a.click();
          },
          
          // 恢复素材
          restoreMaterial: function(key) {
            // 使用Vue.delete确保响应式更新
            this.$delete(this.replacedImages, key);
            // 清空裁剪数据
            this.croppedImageData = null;
            // 重新加载原始SVGA
            if (this.currentFrame) {
              this.loadSVGA(this.currentFrame);
            }
            // 清空图标生成效果
            var canvas = this.$refs.iconCanvas;
            if (canvas) {
              var ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, 300, 300);
            }
            this.showToast('已恢复 ' + key);
          },
          
          // 导出新SVGA
          exportSVGA: function() {
            var _this = this;
            
            if (!_this.svgaFile || Object.keys(_this.replacedImages).length === 0) {
              _this.showToast('请先替换至少一个素材');
              return;
            }
            
            _this.showToast('正在导出...');
            
            var reader = new FileReader();
            reader.onload = function(e) {
              try {
                var arrayBuffer = e.target.result;
                var uint8Array = new Uint8Array(arrayBuffer);
                
                // 解压缩
                var inflatedData = pako.inflate(uint8Array);
                
                // 加载proto并解码
                protobuf.load('svga.proto', function(err, root) {
                  if (err) {
                    _this.showToast('Proto加载失败');
                    return;
                  }
                  
                  try {
                    var MovieEntity = root.lookupType('com.opensource.svga.MovieEntity');
                    var movieData = MovieEntity.decode(inflatedData);
                    
                    // 替换图片
                    for (var imageKey in _this.replacedImages) {
                      if (_this.replacedImages.hasOwnProperty(imageKey) && movieData.images[imageKey]) {
                        var base64Data = _this.replacedImages[imageKey];
                        var base64String = base64Data.split(',')[1] || base64Data;
                        var binaryString = atob(base64String);
                        var bytes = new Uint8Array(binaryString.length);
                        for (var i = 0; i < binaryString.length; i++) {
                          bytes[i] = binaryString.charCodeAt(i);
                        }
                        movieData.images[imageKey] = bytes;
                      }
                    }
                    
                    // 编码并压缩
                    var buffer = MovieEntity.encode(movieData).finish();
                    var deflatedData = pako.deflate(buffer);
                    
                    // 生成文件名：时间戳_文件名
                    var baseName = _this.currentFrame ? _this.currentFrame.name : 'gift';
                    var fileName = _this.getTimestampFilename(baseName, 'svga');
                    
                    // 下载SVGA
                    var blob = new Blob([deflatedData], { type: 'application/octet-stream' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    _this.showToast('导出成功！');
                    
                  } catch (decodeErr) {
                    _this.showToast('编码失败: ' + decodeErr.message);
                  }
                });
                
              } catch (err) {
                _this.showToast('处理失败: ' + err.message);
              }
            };
            reader.readAsArrayBuffer(_this.svgaFile);
          },
          
          // 导出第5帧PNG
          exportFrame5PNG: function(baseName) {
            var _this = this;
            if (!_this.svgaPlayer) return;
            
            // 跳转到第5帧
            _this.svgaPlayer.pauseAnimation();
            _this.svgaPlayer.stepToFrame(4); // 第5帧索引是4
            
            // 获取canvas并导出
            setTimeout(function() {
              var container = document.getElementById('svgaContainer');
              var canvas = container ? container.querySelector('canvas') : null;
              if (canvas) {
                var dataUrl = canvas.toDataURL('image/png');
                var a = document.createElement('a');
                a.href = dataUrl;
                a.download = baseName + '_frame5.png';
                a.click();
              }
              // 恢复播放
              _this.svgaPlayer.startAnimation();
            }, 100);
          },
          
          // 格式化字节
          formatBytes: function(bytes) {
            if (bytes === 0) return '0 B';
            var k = 1024;
            var sizes = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          },
          
          // Toast提示
          showToast: function(message) {
            var _this = this;
            _this.toastMessage = message;
            _this.toastVisible = true;
            setTimeout(function() {
              _this.toastVisible = false;
            }, 2000);
          }
        }
      });
    </script>
  </body>
</html>
