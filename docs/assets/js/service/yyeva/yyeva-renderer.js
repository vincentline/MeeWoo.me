!function(e){"use strict";function t(){this.effectConfig={},this.imageCache={}}e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Services=e.MeeWoo.Services||{},t.prototype={constructor:t,renderEffects:function(e,t,a,r){if(a&&a.datas){var f=a.datas,i=a.effect,o=this._findFrameData(f,t);if(o)for(var n=0;n<o.length;n++){var h=o[n],c=h.effectId,g=null;for(var d in i)if(i[d].effectId==c){g=i[d];break}if(g||(g=i[c]||i[String(c)]),!g){var l=h.outputFrame||h.renderFrame;if(!l)continue;var m=l[2]/l[3],s=[];for(var d in i)s.push(i[d]);for(var v=m>=1.5?"txt":"img",u=0;u<s.length;u++)if(s[u].effectType===v){g=s[u];break}if(!g&&s.length>0&&(g=s[0]),!g)continue}if("txt"===g.effectType)this._renderText(e,g,h,this.effectConfig[g.effectTag]||{},r);else if("img"===g.effectType){var I=this.effectConfig[g.effectTag]||{};I.imageSource&&this._renderImage(e,g,h,I,r)}}}},_findFrameData:function(e,t){for(var a=0;a<e.length;a++)if(e[a].frameIndex===t)return e[a].data;return null},_renderText:function(e,t,a,r,f){var i=a.renderFrame||a.outputFrame,o=a.outputFrame,n=i[0],h=i[1],c=i[2],g=i[3],d=r&&r.text?r.text:t.effectTag||"",l=r&&r.fontSize||t.fontSize||36,m=r&&r.fontColor||t.fontColor||"#ffffff",s=r&&r.textAlign||t.textAlign||"center",v=document.createElement("canvas");v.width=Math.floor(c),v.height=Math.floor(g);var u=v.getContext("2d");u.font=l+"px "+(t.fontFamily||"Arial, sans-serif"),u.fillStyle=m,u.textAlign=s,u.textBaseline="middle",u.fillText(d,c/2,g/2),o&&f&&f.ctx&&this._applyMaskAlpha(u,Math.floor(c),Math.floor(g),o,f),e.drawImage(v,n,h),v.width=0,v.height=0},_renderImage:function(e,t,a,r,f){var i=a.renderFrame,o=a.outputFrame;if(i){var n=i[0],h=i[1],c=i[2],g=i[3],d=r&&r.imageSource;if(null!=d){var l="_yyevaImg_"+t.effectTag,m=this.imageCache[l];if(m||((m=new Image).src=d,this.imageCache[l]=m),m.complete&&m.naturalWidth>0){e.save(),e.beginPath(),e.rect(n,h,c,g),e.clip();var s="scaleFill";o&&f&&f.ctx?this._renderImageWithMask(e,m,n,h,c,g,s,o,f):this._drawImageToCanvas(e,m,n,h,c,g,s),e.restore()}}}},_renderImageWithMask:function(e,t,a,r,f,i,o,n,h){var c=Math.floor(n[0]),g=Math.floor(n[1]),d=Math.floor(n[2]),l=Math.floor(n[3]),m=document.createElement("canvas");m.width=Math.floor(f),m.height=Math.floor(i);var s=m.getContext("2d");this._drawImageToCanvas(s,t,0,0,f,i,o);try{var v=h.ctx,u=h.videoWidth,I=h.videoHeight;if(c>=0&&g>=0&&c+d<=u&&g+l<=I){var M=v.getImageData(c,g,d,l),C=document.createElement("canvas");C.width=d,C.height=l,C.getContext("2d").putImageData(M,0,0);var p=document.createElement("canvas");p.width=Math.floor(f),p.height=Math.floor(i);var w=p.getContext("2d");w.drawImage(C,0,0,d,l,0,0,f,i);for(var x=w.getImageData(0,0,Math.floor(f),Math.floor(i)),T=s.getImageData(0,0,Math.floor(f),Math.floor(i)),_=T.data,y=x.data,D=0;D<_.length;D+=4){var F=y[D];_[D+3]=Math.floor(_[D+3]*F/255)}s.putImageData(T,0,0),C.width=0,p.width=0}}catch(e){}e.drawImage(m,a,r),m.width=0},_drawImageToCanvas:function(e,t,a,r,f,i,o){var n=t.width,h=t.height,c=f,g=i,d=c/g,l=0,m=0,s=n,v=h;n/h>d?l=(n-(s=h*d))/2:m=(h-(v=n/d))/2,e.drawImage(t,l,m,s,v,a,r,c,g)},setText:function(e,t){this.effectConfig[e]||(this.effectConfig[e]={}),Object.assign(this.effectConfig[e],t)},setImage:function(e,t){this.effectConfig[e]||(this.effectConfig[e]={}),this.effectConfig[e].imageSource=t},getEffects:function(e){if(!e||!e.effect)return[];var t=[];for(var a in e.effect){var r=e.effect[a];t.push({effectId:a,effectTag:r.effectTag,effectType:r.effectType,name:r.name||r.effectTag})}return t},_applyMaskAlpha:function(e,t,a,r,f){var i=Math.floor(r[0]),o=Math.floor(r[1]),n=Math.floor(r[2]),h=Math.floor(r[3]),c=f.ctx,g=f.videoWidth,d=f.videoHeight;if(!(i<0||o<0||i+n>g||o+h>d))try{var l=c.getImageData(i,o,n,h),m=document.createElement("canvas");m.width=n,m.height=h,m.getContext("2d").putImageData(l,0,0);var s=document.createElement("canvas");s.width=t,s.height=a;var v=s.getContext("2d");v.drawImage(m,0,0,n,h,0,0,t,a);for(var u=v.getImageData(0,0,t,a).data,I=e.getImageData(0,0,t,a),M=I.data,C=0;C<M.length;C+=4){var p=u[C];M[C+3]=Math.floor(M[C+3]*p/255)}e.putImageData(I,0,0),m.width=0,s.width=0}catch(e){console.error("[YYEVA] 应用蒙版透明度失败:",e)}},clearImageCache:function(){this.imageCache={}},reset:function(){this.effectConfig={},this.clearImageCache()},getFrameData:function(e,t){return this._findFrameData(e,t)}},e.MeeWoo.Services.YyevaRenderer=t}(window);