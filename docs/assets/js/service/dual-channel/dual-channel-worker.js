const BLOCK_SIZE=128,hasSIMD=!1;async function handleComposeFrame(e){console.log("Starting handleComposeFrame, frame data length:",e.frame.data.length,"width:",e.width,"height:",e.height);var o=e.frame.data,r=e.width,a=e.height,t="color-left-alpha-right"===e.mode,s=2*r,n=a,l=s*n*4;console.log("Dual channel image size:",s,"x",n,"data size:",l);var c=new Uint8ClampedArray(l),i=new Uint8ClampedArray(l);console.log("Memory allocated successfully");var h=[];console.log("Generating blocks...");for(var g=0;g<a;g+=128)for(var d=0;d<r;d+=128)h.push({x:d,y:g,width:Math.min(128,r-d),height:Math.min(128,a-g)});console.log("Generated",h.length,"blocks"),console.log("Starting parallel processing of blocks...");try{var f=0,m=h.length;await Promise.all(h.map(async n=>{await processBlock(n,o,r,a,s,c,i,t),f++;var l=Math.round(f/m*100);l%5==0&&self.postMessage({id:e.id,type:"progress",progress:l})})),console.log("Block processing completed")}catch(e){throw console.error("Error during block processing:",e),e}console.log("Posting result back to main thread"),self.postMessage({id:e.id,type:"result",result:{blackBgData:i,dualData:c,width:s,height:n}},[i.buffer,c.buffer]),console.log("Result posted successfully")}async function handleComposeFrames(e){console.log("Starting handleComposeFrames, frame count:",e.data.frames.length);var o=e.data,r=o.frames,a=o.mode,t=r.length;if(0===t)throw new Error("帧数组不能为空");console.log("First frame size:",r[0].width,"x",r[0].height);var s=[],n=r[0].width,l=r[0].height,c="color-left-alpha-right"===a,i=2*n,h=i*l*4;console.log("Dual channel image size per frame:",i,"x",l,"data size:",h);console.log("Worker使用分批处理，每批",20,"帧");for(let o=0;o<t;o+=20){const a=Math.min(o+20,t),f=r.slice(o,a),m=f.length;console.log("Worker处理批次:",o,"-",a,"共",m,"帧");var g=f.map(async function(e,r){const a=o+r;console.log("Processing frame",a+1,"of",t);var s=new Uint8ClampedArray(h),g=new Uint8ClampedArray(h);console.log("Memory allocated for frame",a);for(var d=[],f=0;f<l;f+=128)for(var m=0;m<n;m+=128)d.push({x:m,y:f,width:Math.min(128,n-m),height:Math.min(128,l-f)});console.log("Generated",d.length,"blocks for frame",a);try{await Promise.all(d.map(o=>processBlock(o,e.data,n,l,i,s,g,c))),console.log("Frame",a,"processing completed")}catch(e){return console.error("Error processing frame",a,":",e),null}return{blackBgData:g,width:i,height:l}});console.log("Waiting for batch frames to complete...");try{const o=(await Promise.all(g)).filter(e=>null!==e);s.push(...o),console.log("Batch processed successfully, valid results:",o.length);const r=Math.min(a,t);var d=Math.round(r/totalFrames*100);d%5==0&&self.postMessage({id:e.id,type:"progress",progress:d}),"function"==typeof gc&&gc(),console.log("Batch completed, total results so far:",s.length)}catch(e){console.error("Error in batch processing:",e);continue}}var f=[];s.forEach(e=>{f.push(e.blackBgData.buffer)}),console.log("Extracted transferable objects, count:",f.length),console.log("Posting results back to main thread"),self.postMessage({id:e.id,type:"result",result:s},f),console.log("Results posted successfully, total frames processed:",s.length)}function processBlock(e,o,r,a,t,s,n,l){return new Promise(function(c){var i=e.x,h=e.y,g=(e.width,e.height,1/255);try{processBlockWithoutSIMD(e,o,r,a,t,s,n,l,g),c()}catch(e){console.error("Error processing block:",e,"at position:",i,",",h),c()}})}function processBlockWithSIMD(e,o,r,a,t,s,n,l,c){}function process4PixelsWithSIMD(e,o,r,a,t,s,n,l,c,i,h,g){for(var d=[o*a+e,o*a+e+1,o*a+e+2,o*a+e+3].map(e=>4*e),f=SIMD.int32x4(r[d[0]],r[d[1]],r[d[2]],r[d[3]]),m=SIMD.int32x4(r[d[0]+1],r[d[1]+1],r[d[2]+1],r[d[3]+1]),p=SIMD.int32x4(r[d[0]+2],r[d[1]+2],r[d[2]+2],r[d[3]+2]),u=(SIMD.int32x4(r[d[0]+3],r[d[1]+3],r[d[2]+3],r[d[3]+3]),f),M=m,v=p,y=0;y<4;y++){var x=r[d[y]+3];if(x>0&&x<255){var k=255*c;u=SIMD.int32x4.replaceLane(u,y,Math.min(255,Math.round(r[d[y]]*k))),M=SIMD.int32x4.replaceLane(M,y,Math.min(255,Math.round(r[d[y]+1]*k))),v=SIMD.int32x4.replaceLane(v,y,Math.min(255,Math.round(r[d[y]+2]*k)))}else 0===x&&(u=SIMD.int32x4.replaceLane(u,y,0),M=SIMD.int32x4.replaceLane(M,y,0),v=SIMD.int32x4.replaceLane(v,y,0))}for(y=0;y<4;y++){var w=e+y,D=4*(o*a+w),S=SIMD.int32x4.extractLane(u,y),I=SIMD.int32x4.extractLane(M,y),b=SIMD.int32x4.extractLane(v,y),F=r[D+3],B=4*(o*t+w),C=4*(o*t+w+a);l?(s[B+0]=S,s[B+1]=I,s[B+2]=b,s[B+3]=F,s[C+0]=F,s[C+1]=F,s[C+2]=F,s[C+3]=255):(s[B+0]=F,s[B+1]=F,s[B+2]=F,s[B+3]=255,s[C+0]=S,s[C+1]=I,s[C+2]=b,s[C+3]=F);var E=s[B+3];if(255===E)n[B+0]=s[B+0],n[B+1]=s[B+1],n[B+2]=s[B+2];else if(0===E)n[B+0]=0,n[B+1]=0,n[B+2]=0;else{var P=E*c;n[B+0]=Math.round(s[B+0]*P),n[B+1]=Math.round(s[B+1]*P),n[B+2]=Math.round(s[B+2]*P)}n[B+3]=255;var L=s[C+3];if(255===L)n[C+0]=s[C+0],n[C+1]=s[C+1],n[C+2]=s[C+2];else if(0===L)n[C+0]=0,n[C+1]=0,n[C+2]=0;else{var W=L*c;n[C+0]=Math.round(s[C+0]*W),n[C+1]=Math.round(s[C+1]*W),n[C+2]=Math.round(s[C+2]*W)}n[C+3]=255}}function processBlockWithoutSIMD(e,o,r,a,t,s,n,l,c){for(var i=e.x,h=e.y,g=e.width,d=e.height,f=h;f<h+d;f++)for(var m=i;m<i+g;m++)try{processSinglePixel(m,f,o,r,t,s,n,l,c)}catch(e){console.error("Error processing pixel at",m,",",f,":",e)}}function processSinglePixel(e,o,r,a,t,s,n,l,c){var i=4*(o*a+e);if(i+3>=r.length)console.error("Invalid frame index:",i,"for frame data length:",r.length);else{var h=r[i+0],g=r[i+1],d=r[i+2],f=r[i+3],m=h,p=g,u=d;if(f>0){if(f<255){var M=255*c;m=Math.min(255,Math.round(h*M)),p=Math.min(255,Math.round(g*M)),u=Math.min(255,Math.round(d*M))}}else m=0,p=0,u=0;var v=4*(o*t+e),y=4*(o*t+e+a);if(v+3>=s.length||y+3>=s.length)console.error("Invalid dual data index:",v,"or",y,"for dual data length:",s.length);else{l?(s[v+0]=m,s[v+1]=p,s[v+2]=u,s[v+3]=f,s[y+0]=f,s[y+1]=f,s[y+2]=f,s[y+3]=255):(s[v+0]=f,s[v+1]=f,s[v+2]=f,s[v+3]=255,s[y+0]=m,s[y+1]=p,s[y+2]=u,s[y+3]=f);var x=s[v+3];if(255===x)n[v+0]=s[v+0],n[v+1]=s[v+1],n[v+2]=s[v+2];else if(0===x)n[v+0]=0,n[v+1]=0,n[v+2]=0;else{var k=x*c;n[v+0]=Math.round(s[v+0]*k),n[v+1]=Math.round(s[v+1]*k),n[v+2]=Math.round(s[v+2]*k)}n[v+3]=255;var w=s[y+3];if(255===w)n[y+0]=s[y+0],n[y+1]=s[y+1],n[y+2]=s[y+2];else if(0===w)n[y+0]=0,n[y+1]=0,n[y+2]=0;else{var D=w*c;n[y+0]=Math.round(s[y+0]*D),n[y+1]=Math.round(s[y+1]*D),n[y+2]=Math.round(s[y+2]*D)}n[y+3]=255}}}self.onmessage=function(e){var o=e.data;console.log("Worker received task:",o.type,"Task ID:",o.id);try{switch(o.type){case"composeFrame":console.log("Processing composeFrame task"),handleComposeFrame(o).catch(function(e){console.error("Error in handleComposeFrame:",e),self.postMessage({id:o.id,type:"error",error:e.message})});break;case"composeFrames":console.log("Processing composeFrames task, frame count:",o.data.frames.length),handleComposeFrames(o).catch(function(e){console.error("Error in handleComposeFrames:",e),self.postMessage({id:o.id,type:"error",error:e.message})});break;default:throw new Error("Unknown task type: "+o.type)}}catch(e){console.error("Error in message handler:",e),self.postMessage({id:o.id,type:"error",error:e.message})}};