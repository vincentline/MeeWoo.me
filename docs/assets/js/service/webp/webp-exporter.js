!function(){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};var e=null,o=!1,r={initWebPXMux:async function(){if(e&&o)return e;if("undefined"==typeof WebPXMux){var r=window.MeeWoo.Core.libraryLoader;if(r&&await r.load(["webpxmux"],!0),"undefined"==typeof WebPXMux)throw new Error("WebPXMux 库加载失败")}return e=WebPXMux("assets/js/lib/webpxmux/webpxmux.wasm"),await e.waitRuntime(),o=!0,console.log("[WebP导出] webpxmux 初始化完成"),e},imageDataToRGBA:function(e){for(var o=e.data,r=e.width*e.height,t=new Uint32Array(r),n=0;n<r;n++){var a=o[4*n],i=o[4*n+1],w=o[4*n+2],d=o[4*n+3];t[n]=a<<24|i<<16|w<<8|d}return t},export:async function(e){var o=this;if(!e.getFrame)throw new Error("缺少 getFrame 回调");if(!e.totalFrames||e.totalFrames<=0)throw new Error("帧数无效");var r=e.width||300,t=e.height||300,n=e.fps||30,a=e.totalFrames,i=e.onProgress||function(){},w=e.onError||function(){},d=e.shouldCancel||function(){return!1};try{i(0,"init","初始化编码器...");var c=await this.initWebPXMux();if(d())throw new Error("导出已取消");var u=document.createElement("canvas");u.width=r,u.height=t;var l=u.getContext("2d",{willReadFrequently:!0,alpha:!0});i(.05,"capturing","捕获帧数据...");for(var h=[],s=Math.round(1e3/n),f=0;f<a;f++){if(d())throw new Error("导出已取消");var m=await e.getFrame(f);if(m){l.clearRect(0,0,r,t),l.drawImage(m,0,0,r,t);var b=l.getImageData(0,0,r,t),g=o.imageDataToRGBA(b);h.push({duration:s,isKeyframe:0===f,rgba:g}),i(.05+f/a*.55,"capturing","捕获帧 "+(f+1)+"/"+a)}else console.warn("[WebP导出] 帧 "+f+" 获取失败，跳过")}if(0===h.length)throw new Error("没有捕获到任何帧");console.log("[WebP导出] 捕获完成，共 "+h.length+" 帧"),i(.6,"encoding","编码WebP动画...");var p={frameCount:h.length,width:r,height:t,loopCount:0,bgColor:0,frames:h};if(d())throw new Error("导出已取消");i(.7,"encoding","正在编码...");var v=await c.encodeFrames(p);if(!v||0===v.length)throw new Error("webpxmux编码失败，未生成输出数据");i(.9,"downloading","生成下载文件...");var x=new Blob([v],{type:"image/webp"});return console.log("[WebP导出] 输出文件大小:",o.formatBytes(x.size)),o.download(x,"animation.webp"),i(1,"completed","导出完成"),x}catch(e){throw console.error("[WebP导出] 导出失败:",e),w(e),e}},download:function(e,o){var r=URL.createObjectURL(e),t=document.createElement("a");t.href=r,t.download=o||"animation.webp",document.body.appendChild(t),t.click(),document.body.removeChild(t),window.MeeWoo&&window.MeeWoo.Service&&window.MeeWoo.Service.TimerService?window.MeeWoo.Service.TimerService.createDelay(function(){URL.revokeObjectURL(r)},100,"webp-export"):setTimeout(function(){URL.revokeObjectURL(r)},100)},estimate:function(e){var o=e.width||300,r=e.height||300,t=e.fps||30,n=e.duration||0,a=Math.ceil(n*t),i=o*r*.05*a;return{totalFrames:a,totalBytes:i,fileSizeText:this.formatBytes(i)}},formatBytes:function(e){if(0===e)return"0 B";var o=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,o)).toFixed(2)+" "+["B","KB","MB","GB"][o]}};window.MeeWoo.Exporters.WebPExporter=r}(window);