!function(){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const e={export:async function(e){if(!e.getFrame)throw new Error("缺少 getFrame 回调");var r=e.width||300,o=e.height||300,t=(e.fps,e.onProgress||function(){}),n=e.onError||function(){},a=e.shouldCancel||function(){return!1};try{t(0,"capturing","捕获帧数据...");var i=document.createElement("canvas");i.width=r,i.height=o;for(var w=i.getContext("2d",{willReadFrequently:!0,alpha:!0}),c=null,d=0;!c&&d<3;){d++;try{(c=await e.getFrame(0))||(console.warn("[WebP导出] 第"+d+"次尝试获取帧数据失败，重试..."),await new Promise(e=>setTimeout(e,200)))}catch(e){console.warn("[WebP导出] 第"+d+"次尝试获取帧数据出错:",e),await new Promise(e=>setTimeout(e,200))}}if(!c)throw new Error("无法获取帧数据");if(0===c.width||0===c.height)throw new Error("获取的帧画布尺寸无效");if(a())throw new Error("导出已取消");t(.3,"converting","转换为WebP格式..."),w.clearRect(0,0,r,o),w.drawImage(c,0,0,r,o);var h=i.toDataURL("image/webp",.9);t(.8,"downloading","生成下载文件...");var u=document.createElement("a");return u.href=h,u.download="export.webp",document.body.appendChild(u),u.click(),document.body.removeChild(u),t(1,"completed","导出完成"),h}catch(e){throw n(e),e}},captureFrames:async function(e){var r=e.width||300,o=e.height||300,t=e.fps||30,n=e.duration||1,a=Math.ceil(n*t),i=[],w=e.seekToFrame,c=e.getCurrentFrameCanvas,d=e.onProgress||function(){},h=e.shouldCancel||function(){return!1};if(!w||!c)throw new Error("缺少必要的帧操作方法");for(var u=0;u<a;u++){if(h())throw new Error("导出已取消");var s=Math.floor(u/t*t);await w(s,t);var m=c();if(!m)throw new Error("无法获取帧画布");var l=document.createElement("canvas");l.width=r,l.height=o,l.getContext("2d").drawImage(m,0,0,r,o);var g=new Image;g.src=l.toDataURL("image/png"),await new Promise(function(e){g.onload=e}),i.push(g),d(u/a*.3,"capturing","捕获帧数据...")}return i}};window.MeeWoo.Exporters.WebPExporter=e}(window);