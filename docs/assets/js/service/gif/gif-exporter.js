!function(e){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const r={encoder:null,export:async function(e){if(!e.getFrame)throw new Error("缺少 getFrame 回调");if(!e.totalFrames||e.totalFrames<=0)throw new Error("帧数无效");if("undefined"==typeof GIF){if(!(window.MeeWoo&&window.MeeWoo.Core&&window.MeeWoo.Core.libraryLoader))throw new Error("库加载器不可用");try{await window.MeeWoo.Core.libraryLoader.load("gif",!0)}catch(e){throw new Error("GIF.js库加载失败: "+e.message)}}var r=e.width||300,o=e.height||300,t=e.fps||30,n=e.totalFrames,a=Math.round(1e3/t),i=e.transparent||!1,f=e.dither||!1,s=e.ditherColor||"#ffffff",c=31-Math.max(1,Math.min(30,e.quality||10)),d=e.onProgress||function(){},w=e.onComplete||function(){},h=e.onError||function(){},u=e.shouldCancel||function(){return!1},l=document.createElement("canvas");l.width=r,l.height=o;var m=l.getContext("2d",{willReadFrequently:!0,alpha:!0});if("undefined"==typeof Worker)throw new Error("浏览器不支持Web Worker，无法导出GIF");var g=navigator.hardwareConcurrency||2,p=Math.max(1,Math.min(Math.floor(g/2),4)),v=window.location.origin,M={workers:p,workerScript:new URL("assets/js/service/gif/gif.worker.js",v).href,quality:Math.min(c,20),width:r,height:o,repeat:0,background:"#ffffff"};i?M.transparent=0:("transparent"===(F=e.backgroundColor||"#ffffff")&&(F="#ffffff"),M.background=F);var b=new GIF(M),E=new Promise(function(e,r){b.on("progress",function(e){d(50+Math.floor(50*e),"encoding","编码中...")}),b.on("finished",function(o){o&&"object"==typeof o&&o.size?e(o):r(new Error("GIF编码器生成的blob无效"))}),b.on("abort",function(){r(new Error("用户取消"))}),b.on("error",function(e){e.message&&(e.message.includes("Worker")||e.message.includes("worker"))?r(new Error("Worker相关错误: "+(e.message||e)+"，请尝试禁用Worker重试")):r(new Error("GIF编码失败: "+(e.message||e)))})});try{for(var y=0;y<n;y++){if(u())throw b.abort(),new Error("用户取消");var F,I=await e.getFrame(y);if(!I)throw new Error("无法获取帧 "+y);if(m.clearRect(0,0,r,o),!i)"transparent"===(F=e.backgroundColor||"#ffffff")&&(F="#ffffff"),m.fillStyle=F,m.fillRect(0,0,r,o);m.globalCompositeOperation="source-over",m.drawImage(I,0,0,r,o),i&&(f&&s?this._processDither(m,r,o,s):this._processAlphaThreshold(m,r,o));var W=m.getImageData(0,0,r,o);if(!W||!W.data||0===W.data.length)throw new Error("处理后的图像数据无效");var k={delay:a};i&&(k.transparent=!0),b.addFrame(W,k);var x=Math.floor(y/n*50);d(x,"capturing","捕获帧 "+(y+1)+"/"+n)}d(50,"encoding","编码中...");try{b.render()}catch(e){throw console.error("[GIF Exporter] 编码启动失败:",e),new Error("编码启动失败: "+e.message)}var C=new Promise(function(e,r){setTimeout(function(){if(b)try{b.abort()}catch(e){console.warn("[GIF Exporter] 取消编码时出错:",e)}r(new Error("GIF编码超时，可能是由于GIF.js库问题或文件过大导致"))},12e4)}),G=await Promise.race([E,C]);if(!G||"object"!=typeof G||!G.size)throw new Error("生成的GIF blob无效");return w(G,G.size),G}catch(e){throw h(e),e}},_processDither:function(e,r,o,t){for(var n=e.getImageData(0,0,r,o),a=n.data,i=t.replace("#",""),f=parseInt(i.substr(0,2),16),s=parseInt(i.substr(2,2),16),c=parseInt(i.substr(4,2),16),d=0;d<a.length;d+=4){var w=a[d+3]/255;w>0&&w<1&&(a[d]=Math.round(a[d]*w+f*(1-w)),a[d+1]=Math.round(a[d+1]*w+s*(1-w)),a[d+2]=Math.round(a[d+2]*w+c*(1-w)),a[d+3]=255)}e.putImageData(n,0,0)},_processAlphaThreshold:function(e,r,o){for(var t=e.getImageData(0,0,r,o),n=t.data,a=0;a<n.length;a+=4){var i=n[a+3];i>0&&i<255&&(n[a+3]=i<128?0:255)}e.putImageData(t,0,0)},download:function(e,r){var o=URL.createObjectURL(e),t=document.createElement("a");t.href=o,t.download=r||"animation.gif",document.body.appendChild(t),t.click(),document.body.removeChild(t),window.MeeWoo&&window.MeeWoo.Service&&window.MeeWoo.Service.TimerService?window.MeeWoo.Service.TimerService.createDelay(function(){URL.revokeObjectURL(o)},100,"gif-export"):setTimeout(function(){URL.revokeObjectURL(o)},100)},estimate:function(e){var r=e.width||100,o=e.height||100,t=e.fps||30,n=e.duration||0,a=Math.ceil(n*t),i=e.transparent||!1,f=e.dither||!1,s=i?.16:.13;i&&f&&(s=.18);var c=r*o*s*a,d="？";return a>0&&(d=c>=1048576?(c/1024/1024).toFixed(2)+"M":Math.round(c/1024)+"kb"),{frames:a,duration:n,fileSize:d,fileSizeBytes:c}},formatBytes:function(e){return e>=1048576?(e/1024/1024).toFixed(2)+" MB":e>=1024?(e/1024).toFixed(1)+" KB":e+" B"}};e.MeeWoo.Exporters.GifExporter=r}("undefined"!=typeof window?window:this);