!function(r){"use strict";window.MeeWoo=window.MeeWoo||{},window.MeeWoo.Exporters=window.MeeWoo.Exporters||{};const e={encoder:null,export:async function(r){if(!r.getFrame)throw new Error("缺少 getFrame 回调");if(!r.totalFrames||r.totalFrames<=0)throw new Error("帧数无效");if("undefined"==typeof GIF){if(!(window.MeeWoo&&window.MeeWoo.Core&&window.MeeWoo.Core.libraryLoader))throw new Error("库加载器不可用");try{await window.MeeWoo.Core.libraryLoader.load("gif",!0)}catch(r){throw new Error("GIF.js库加载失败: "+r.message)}}var e=r.width||300,o=r.height||300,t=r.fps||30,n=r.totalFrames,a=Math.round(1e3/t),i=r.transparent||!1,s=r.dither||!1,c=r.ditherColor||"#ffffff",f=31-Math.max(1,Math.min(30,r.quality||10)),d=r.onProgress||function(){},l=r.onComplete||function(){},h=r.onError||function(){},w=r.shouldCancel||function(){return!1},g=document.createElement("canvas");g.width=e,g.height=o;var u=g.getContext("2d",{willReadFrequently:!0,alpha:!0});if("undefined"==typeof Worker)throw new Error("浏览器不支持Web Worker，无法导出GIF");var p=navigator.hardwareConcurrency||2,m=Math.max(1,Math.min(Math.floor(p/2),4)),E=window.location.origin,F=new URL("assets/js/service/gif/gif.worker.js",E).href;console.log("[GIF Exporter] Worker script path:",F);var I,G=function(t){var n={workers:t?m:0,workerScript:F,quality:Math.min(f,20),width:e,height:o,repeat:0,background:"#ffffff",debug:!0};if(i)n.transparent=0;else{var a=r.backgroundColor||"#ffffff";"transparent"===a&&(a="#ffffff"),n.background=a}return new GIF(n)};try{I=G(!0),console.log("[GIF Exporter] Created GIF instance with worker")}catch(r){console.warn("[GIF Exporter] Worker creation failed, falling back to main thread:",r.message),I=G(!1),console.log("[GIF Exporter] Created GIF instance with main thread")}var v=new Promise(function(r,e){I.on("progress",function(r){var e=50+Math.floor(50*r);d(e,"encoding","编码中..."),console.log("[GIF Exporter] Encoding progress:",e+"%")}),I.on("finished",function(o){console.log("[GIF Exporter] Encoding finished, blob size:",o?o.size:"null"),o&&"object"==typeof o&&o.size?r(o):e(new Error("GIF编码器生成的blob无效"))}),I.on("abort",function(){console.log("[GIF Exporter] Encoding aborted"),e(new Error("用户取消"))}),I.on("error",function(o){if(console.error("[GIF Exporter] 编码错误:",o),console.error("[GIF Exporter] Error stack:",o.stack),o.message&&(o.message.includes("Worker")||o.message.includes("worker"))){console.warn("[GIF Exporter] Worker相关错误，切换到主线程编码");try{console.log("[GIF Exporter] Creating new GIF instance without worker");var t=G(!1);console.log("[GIF Exporter] Re-adding frames to main thread GIF");for(var s=0;s<n;s++){var c={delay:a};i&&(c.transparent=!0),t.addFrame(x[s],c)}console.log("[GIF Exporter] Starting main thread encoding"),t.render(),t.on("progress",function(r){var e=50+Math.floor(50*r);d(e,"encoding","编码中..."),console.log("[GIF Exporter] Main thread encoding progress:",e+"%")}),t.on("finished",function(e){console.log("[GIF Exporter] Main thread encoding finished"),r(e)}),t.on("error",function(r){console.error("[GIF Exporter] Main thread encoding error:",r),e(new Error("主线程编码失败: "+(r.message||r)))})}catch(r){console.error("[GIF Exporter] Failed to retry with main thread:",r),e(new Error("Worker相关错误: "+(o.message||o)+"，主线程重试也失败"))}}else e(new Error("GIF编码失败: "+(o.message||o)))})}),x=[];try{for(var b=0;b<n;b++){if(w())throw I.abort(),new Error("用户取消");var M=await r.getFrame(b);if(!M)throw new Error("无法获取帧 "+b);if(u.clearRect(0,0,e,o),!i){var y=r.backgroundColor||"#ffffff";"transparent"===y&&(y="#ffffff"),u.fillStyle=y,u.fillRect(0,0,e,o)}u.globalCompositeOperation="source-over",u.drawImage(M,0,0,e,o),i&&(s&&c?this._processDither(u,e,o,c):this._processAlphaThreshold(u,e,o));var k=u.getImageData(0,0,e,o);if(!k||!k.data||0===k.data.length)throw new Error("处理后的图像数据无效");var C={delay:a};i&&(C.transparent=!0),I.addFrame(k,C),x.push(k);var W=Math.floor(b/n*50);d(W,"capturing","捕获帧 "+(b+1)+"/"+n),console.log("[GIF Exporter] Captured frame",b+1,"of",n)}d(50,"encoding","编码中...");try{I.render()}catch(r){throw console.error("[GIF Exporter] 编码启动失败:",r),new Error("编码启动失败: "+r.message)}var R=new Promise(function(r,e){setTimeout(function(){if(I)try{I.abort()}catch(r){console.warn("[GIF Exporter] 取消编码时出错:",r)}e(new Error("GIF编码超时，可能是由于GIF.js库问题或文件过大导致"))},12e4)}),j=await Promise.race([v,R]);if(!j||"object"!=typeof j||!j.size)throw new Error("生成的GIF blob无效");return l(j,j.size),j}catch(r){throw h(r),r}},_processDither:function(r,e,o,t){for(var n=r.getImageData(0,0,e,o),a=n.data,i=t.replace("#",""),s=parseInt(i.substr(0,2),16),c=parseInt(i.substr(2,2),16),f=parseInt(i.substr(4,2),16),d=0;d<a.length;d+=4){var l=a[d+3]/255;l>0&&l<1&&(a[d]=Math.round(a[d]*l+s*(1-l)),a[d+1]=Math.round(a[d+1]*l+c*(1-l)),a[d+2]=Math.round(a[d+2]*l+f*(1-l)),a[d+3]=255)}r.putImageData(n,0,0)},_processAlphaThreshold:function(r,e,o){for(var t=r.getImageData(0,0,e,o),n=t.data,a=0;a<n.length;a+=4){var i=n[a+3];i>0&&i<255&&(n[a+3]=i<128?0:255)}r.putImageData(t,0,0)},download:function(r,e){var o=URL.createObjectURL(r),t=document.createElement("a");t.href=o,t.download=e||"animation.gif",document.body.appendChild(t),t.click(),document.body.removeChild(t),setTimeout(function(){URL.revokeObjectURL(o)},100)},estimate:function(r){var e=r.width||100,o=r.height||100,t=r.fps||30,n=r.duration||0,a=Math.ceil(n*t),i=r.transparent||!1,s=r.dither||!1,c=i?.16:.13;i&&s&&(c=.18);var f=e*o*c*a,d="？";return a>0&&(d=f>=1048576?(f/1024/1024).toFixed(2)+"M":Math.round(f/1024)+"kb"),{frames:a,duration:n,fileSize:d,fileSizeBytes:f}},formatBytes:function(r){return r>=1048576?(r/1024/1024).toFixed(2)+" MB":r>=1024?(r/1024).toFixed(1)+" KB":r+" B"}};r.MeeWoo.Exporters.GifExporter=e}("undefined"!=typeof window?window:this);