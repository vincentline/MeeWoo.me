!function(e){"use strict";e.MeeWoo=e.MeeWoo||{},e.MeeWoo.Core=e.MeeWoo.Core||{};var r={initStage:function(r,n){if("undefined"==typeof Konva)throw new Error("Konva library not loaded");var a={width:e.innerWidth,height:e.innerHeight,backgroundColor:null,performance:{enableBatchRendering:!0,enableLayerCaching:!0,batchDelay:16}},t=Object.assign({},a,n),i=new Konva.Stage({container:r,width:t.width,height:t.height}),o={stage:i,layers:this.createDefaultLayers(i,t.performance.enableLayerCaching),config:t,isInitialized:!0};return t.performance&&this.initPerformanceOptimization(o),this.initStageEvents(o),o},initPerformanceOptimization:function(e){void 0!==MeeWoo.Core.KonvaPerformance&&(e.performanceOptimizer=MeeWoo.Core.KonvaPerformance.initPerformanceOptimizer(e))},createDefaultLayers:function(e,r){var n=new Konva.Layer({name:"backgroundLayer"}),a=new Konva.Layer({name:"editLayer"}),t=new Konva.Layer({name:"helperLayer"}),i=new Konva.Layer({name:"uiLayer"});return r&&(n.setAttr("cacheEnabled",!0),a.setAttr("cacheEnabled",!1),t.setAttr("cacheEnabled",!1),i.setAttr("cacheEnabled",!1)),e.add(n,a,t,i),{backgroundLayer:n,editLayer:a,helperLayer:t,uiLayer:i}},initStageEvents:function(r){r.stage;r.eventListeners={resize:this.handleStageResize.bind(this,r)},e.addEventListener("resize",r.eventListeners.resize)},handleStageResize:function(e){var r=e.stage,n=r.container();if(n){var a=n.getBoundingClientRect();r.width(a.width),r.height(a.height)}},updateStageSize:function(e,r,n){var a=e.stage;a.width(r),a.height(n)},getLayer:function(e,r){return e.layers[r]||null},redrawLayers:function(e,r,n){"string"==typeof r&&(r=[r]);var a=[];r.forEach(function(r){var n=e.layers[r];n&&a.push(n)}),e.performanceOptimizer&&e.performanceOptimizer.batchRenderer&&!n?a.forEach(function(r){e.performanceOptimizer.batchRenderer.addRenderTask(r)}):a.forEach(function(e){e.draw()})},redrawAll:function(e,r){var n=e.stage;if(e.performanceOptimizer&&e.performanceOptimizer.batchRenderer&&!r){for(var a in e.layers)if(e.layers.hasOwnProperty(a)){var t=e.layers[a];e.performanceOptimizer.batchRenderer.addRenderTask(t)}}else n.draw()},flushRender:function(e){e.performanceOptimizer&&e.performanceOptimizer.batchRenderer&&e.performanceOptimizer.batchRenderer.flush()},clearRenderQueue:function(e){e.performanceOptimizer&&e.performanceOptimizer.batchRenderer&&e.performanceOptimizer.batchRenderer.clearQueue()},destroyStage:function(r){r.eventListeners&&r.eventListeners.resize&&e.removeEventListener("resize",r.eventListeners.resize),r.performanceOptimizer&&(r.performanceOptimizer.batchRenderer&&r.performanceOptimizer.batchRenderer.clearQueue(),r.performanceOptimizer.cacheManager&&r.performanceOptimizer.cacheManager.clearAllCache(),r.performanceOptimizer=null),r.stage&&r.stage.destroy(),r.isInitialized=!1,r.stage=null,r.layers=null}};e.MeeWoo.Core.KonvaStage=r}(window);