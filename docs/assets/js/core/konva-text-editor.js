!function(t){"use strict";t.MeeWoo=t.MeeWoo||{},t.MeeWoo.Core=t.MeeWoo.Core||{};var e={createTextLayer:function(t,e){if("undefined"==typeof Konva)throw new Error("Konva library not loaded");var a={x:0,y:0,text:"文案内容",fontSize:24,fontFamily:"Arial",fill:"#000000",align:"center",verticalAlign:"middle",draggable:!0,id:"text-layer-"+Date.now()+"-"+Math.floor(1e4*Math.random())},n=Object.assign({},a,t),o=new Konva.Text(n);return o.setAttr("elementType","text"),o.setAttr("elementData",n),o.setAttr("isTextLayer",!0),e&&this.initTextLayerEvents(o,e),o},initTextLayerEvents:function(t,e){t.on("click tap",function(t){t.cancelBubble=!0,e.editor.activeElement="text",e.editor.lastClickElement="text",e.editor.lastClickTime=Date.now()}),t.on("dragstart",function(){e.editor.isTextDragging=!0,e.editor.textDragStartX=e.editor.textPosX,e.editor.textDragStartY=e.editor.textPosY}),t.on("dragmove",function(){var a=t.position(),n=e.editor.baseImageWidth||500,o=e.editor.baseImageHeight||500,i=a.x/n*100,r=a.y/o*100;e.editor.textPosX=i,e.editor.textPosY=r}),t.on("dragend",function(){e.editor.isTextDragging=!1,e.updateRestoreBtnState&&e.updateRestoreBtnState()})},showTextLayer:function(t){t&&t instanceof Konva.Text&&(t.visible(!0),t.getLayer().draw())},hideTextLayer:function(t){t&&t instanceof Konva.Text&&(t.visible(!1),t.getLayer().draw())},toggleTextLayer:function(t){if(t&&t instanceof Konva.Text){var e=!t.visible();return t.visible(e),t.getLayer().draw(),e}return!1},updateTextContent:function(t,e){if(t&&t instanceof Konva.Text){t.text(e);var a=t.getAttr("elementData")||{};a.text=e,t.setAttr("elementData",a),t.getLayer().draw()}},getTextContent:function(t){return t&&t instanceof Konva.Text?t.text():""},updateTextStyle:function(t,e){if(t&&t instanceof Konva.Text){t.setAttrs(e);var a=t.getAttr("elementData")||{};t.setAttr("elementData",Object.assign({},a,e)),t.getLayer().draw()}},createLinearGradient:function(t,e){var a=Object.assign({},{x0:0,y0:0,x1:100,y1:0,stops:[0,"red",1,"blue"]},e);return new Konva.LinearGradient(a)},createRadialGradient:function(t,e){var a=Object.assign({},{cx:50,cy:50,r:50,stops:[0,"red",1,"blue"]},e);return new Konva.RadialGradient(a)},setTextStroke:function(t,e){if(t&&t instanceof Konva.Text){var a=Object.assign({},{stroke:"#000000",strokeWidth:1},e);t.stroke(a.stroke),t.strokeWidth(a.strokeWidth);var n=t.getAttr("elementData")||{};n.stroke=a.stroke,n.strokeWidth=a.strokeWidth,t.setAttr("elementData",n),t.getLayer().draw()}},setTextShadow:function(t,e){if(t&&t instanceof Konva.Text){var a=Object.assign({},{shadowColor:"black",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0,shadowOpacity:.5},e);t.shadowColor(a.shadowColor),t.shadowBlur(a.shadowBlur),t.shadowOffsetX(a.shadowOffsetX),t.shadowOffsetY(a.shadowOffsetY),t.shadowOpacity(a.shadowOpacity);var n=t.getAttr("elementData")||{};n.shadowColor=a.shadowColor,n.shadowBlur=a.shadowBlur,n.shadowOffsetX=a.shadowOffsetX,n.shadowOffsetY=a.shadowOffsetY,n.shadowOpacity=a.shadowOpacity,t.setAttr("elementData",n),t.getLayer().draw()}},enableTextDragging:function(t,e){t&&t instanceof Konva.Text&&(t.draggable(!0),"function"==typeof e&&t.on("dragend",function(){e({x:t.x(),y:t.y()})}))},disableTextDragging:function(t){t&&t instanceof Konva.Text&&t.draggable(!1)},setTextPosition:function(t,e,a){if(t&&t instanceof Konva.Text){t.position({x:e,y:a});var n=t.getAttr("elementData")||{};n.x=e,n.y=a,t.setAttr("elementData",n),t.getLayer().draw()}},getTextPosition:function(t){return t&&t instanceof Konva.Text?{x:t.x(),y:t.y()}:{x:0,y:0}},setTextScale:function(t,e,a){if(t&&t instanceof Konva.Text){t.scale({x:e,y:a});var n=t.getAttr("elementData")||{};n.scaleX=e,n.scaleY=a,t.setAttr("elementData",n),t.getLayer().draw()}},getTextScale:function(t){return t&&t instanceof Konva.Text?{x:t.scaleX(),y:t.scaleY()}:{x:1,y:1}},createTextFromState:function(t,e){var a=t.baseImageWidth||500,n=t.baseImageHeight||500,o={x:(t.textPosX||50)/100*a,y:(t.textPosY||50)/100*n,text:t.textContent||"文案内容",fontSize:24,fontFamily:"Arial",fill:"#000000",align:t.textAlign||"center",verticalAlign:"middle",scaleX:t.textScale||1,scaleY:t.textScale||1};if(t.textStyle)try{var i=this.parseTextStyle(t.textStyle);Object.assign(o,i)}catch(t){console.error("Failed to parse text style:",t)}return this.createTextLayer(o,e)},syncTextToState:function(t,e){if(t&&t instanceof Konva.Text){var a=e.baseImageWidth||500,n=e.baseImageHeight||500,o=t.x()/a*100,i=t.y()/n*100;e.textContent=t.text(),e.textPosX=Math.max(0,Math.min(100,o)),e.textPosY=Math.max(0,Math.min(100,i)),e.textScale=t.scaleX(),e.textAlign=t.align(),e.textStyle=this.generateTextStyle(t)}},parseTextStyle:function(t){var e={};return t.split(";").forEach(function(t){var a=t.split(":");if(2===a.length){var n=a[0].trim(),o=a[1].trim();switch(n){case"font-size":e.fontSize=parseInt(o);break;case"font-family":e.fontFamily=o;break;case"color":e.fill=o;break;case"text-align":e.align=o;break;case"font-weight":case"font-style":e.fontStyle=o}}}),e},generateTextStyle:function(t){var e=[];return e.push("font-size: "+t.fontSize()+"px"),e.push("font-family: "+t.fontFamily()),e.push("color: "+t.fill()),e.push("text-align: "+t.align()),t.fontStyle()&&e.push("font-style: "+t.fontStyle()),t.fontWeight()&&e.push("font-weight: "+t.fontWeight()),e.join("; ")},applyRichTextStyle:function(t,e){if(t&&t instanceof Konva.Text){if(e.fontSize&&t.fontSize(e.fontSize),e.fontFamily&&t.fontFamily(e.fontFamily),e.fontStyle&&t.fontStyle(e.fontStyle),e.fontWeight&&t.fontWeight(e.fontWeight),e.align&&t.align(e.align),e.verticalAlign&&t.verticalAlign(e.verticalAlign),e.fill)t.fill(e.fill);else if(e.gradient)if("linear"===e.gradient.type){var a=this.createLinearGradient(t.getStage(),e.gradient.options);t.fill(a)}else if("radial"===e.gradient.type){var n=this.createRadialGradient(t.getStage(),e.gradient.options);t.fill(n)}e.stroke&&this.setTextStroke(t,e.stroke),e.shadow&&this.setTextShadow(t,e.shadow);var o=t.getAttr("elementData")||{};Object.assign(o,e),t.setAttr("elementData",o),t.getLayer().draw()}}};t.MeeWoo.Core.KonvaTextEditor=e}(window);